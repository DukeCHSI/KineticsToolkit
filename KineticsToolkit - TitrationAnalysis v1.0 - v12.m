(* ::Package:: *)

(* ::Input::Initialization:: *)
BeginPackage["KineticsToolkit`"]

TitrationAnalysis::usage="For titration analysis of Carterra, T200 and BLI"

Begin["Private`"]

Print["Version: 1.0 (Initial Release)\nAuthor: Kan (Jonathan) Li, Duke University\nPlease use BLI, T200 or Carterra for module selection"]

TitrationAnalysis[method_]:=Module[{methodtemp=method},
Rmaxlist={Rmax1,Rmax2,Rmax3,Rmax4,Rmax5};
tstartlist={tstart1,tstart2,tstart3,tstart4,tstart5};
shiftlist={shift1,shift2,shift3,shift4,shift5};bshiftlist={bshift1,bshift2,bshift3,bshift4,bshift5};
(*(Without regeneration)*)
RTNoregen[t_,i_]:=Rmaxlist[[i]]*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kd)*(1-E^(-(ka*CanalyteConc[[i]]+kd)*(t+tstartlist[[i]])));
RTdisNonregen[t_,i_]:=Rmaxlist[[i]]*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kd)*(1-E^(-(ka*CanalyteConc[[i]]+kd)*(t0+tstartlist[[i]])))*E^(-kd*(t-t0));
(*(With regeneration)*)
RTRegen[t_,i_]:=Rmaxlist[[i]]*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kd)*(1-E^(-(ka*CanalyteConc[[i]]+kd)*(t-tstartall)));
RTdisRegen[t_,i_]:=Rmaxlist[[i]]*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kd)*(1-E^(-(ka*CanalyteConc[[i]]+kd)*(t0-tstartall)))*E^(-kd*(t-t0));
(*(Without regeneration, fixed off rate)*)
RTNoregenkd[t_,i_]:=Rmaxlist[[i]]*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kdfix)*(1-E^(-(ka*CanalyteConc[[i]]+kdfix)*(t+tstartlist[[i]])));
RTdisNonregenkd[t_,i_]:=Rmaxlist[[i]]*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kdfix)*(1-E^(-(ka*CanalyteConc[[i]]+kdfix)*(t0+tstartlist[[i]])))*E^(-kdfix*(t-t0));
(*(With regeneration, fixed off rate)*)RTRegenkd[t_,i_]:=Rmaxlist[[i]]*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kdfix)*(1-E^(-(ka*CanalyteConc[[i]]+kdfix)*(t-tstartall)));
RTdisRegenkd[t_,i_]:=Rmaxlist[[i]]*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kdfix)*(1-E^(-(ka*CanalyteConc[[i]]+kdfix)*(t0-tstartall)))*E^(-kdfix*(t-t0));
(*(Without regeneration, with shift)*)
RTNoregenbk[t_,i_]:=Rmaxlist[[i]]*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kd)*(1-E^(-(ka*CanalyteConc[[i]]+kd)*(t+tstartlist[[i]])));
RTdisNonregenbk[t_,i_]:=(Rmaxlist[[i]]+shiftlist[[i]])*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kd)*(1-E^(-(ka*CanalyteConc[[i]]+kd)*(t0+tstartlist[[i]])))*E^(-kd*(t-t0));
(*(With regeneration, with shift)*)
RTRegenbk[t_,i_]:=Rmaxlist[[i]]*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kd)*(1-E^(-(ka*CanalyteConc[[i]]+kd)*(t-tstartall)));
RTdisRegenbk[t_,i_]:=(Rmaxlist[[i]]+shiftlist[[i]])*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kd)*(1-E^(-(ka*CanalyteConc[[i]]+kd)*(t0-tstartall)))*E^(-kd*(t-t0));(*(Without regeneration, with bulk shift)*)
RTNoregenbk2[t_,i_]:=bshiftlist[[i]]+Rmaxlist[[i]]*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kd)*(1-E^(-(ka*CanalyteConc[[i]]+kd)*(t+tstartlist[[i]])));
RTdisNonregenbk2[t_,i_]:=Rmaxlist[[i]]*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kd)*(1-E^(-(ka*CanalyteConc[[i]]+kd)*(t0+tstartlist[[i]])))*E^(-kd*(t-t0));
(*(With regeneration, with bulk shift)*)
RTRegenbk2[t_,i_]:=bshiftlist[[i]]+Rmaxlist[[i]]*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kd)*(1-E^(-(ka*CanalyteConc[[i]]+kd)*(t-tstartall)));
RTdisRegenbk2[t_,i_]:=Rmaxlist[[i]]*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kd)*(1-E^(-(ka*CanalyteConc[[i]]+kd)*(t0-tstartall)))*E^(-kd*(t-t0));
(*(Without regeneration, fixed off rate, with shift)*)
RTNoregenkdbk[t_,i_]:=Rmaxlist[[i]]*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kdfix)*(1-E^(-(ka*CanalyteConc[[i]]+kdfix)*(t+tstartlist[[i]])));
RTdisNonregenkdbk[t_,i_]:=(Rmaxlist[[i]]+shiftlist[[i]])*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kdfix)*(1-E^(-(ka*CanalyteConc[[i]]+kdfix)*(t0+tstartlist[[i]])))*E^(-kdfix*(t-t0));
(*(With regeneration, fixed off rate, with shift)*)
RTRegenkdbk[t_,i_]:=Rmaxlist[[i]]*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kdfix)*(1-E^(-(ka*CanalyteConc[[i]]+kdfix)*(t-tstartall)));
RTdisRegenkdbk[t_,i_]:=(Rmaxlist[[i]]+shiftlist[[i]])*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kdfix)*(1-E^(-(ka*CanalyteConc[[i]]+kdfix)*(t0-tstartall)))*E^(-kdfix*(t-t0));(*(Without regeneration, fixed off rate, with bulk shift)*)
RTNoregenkdbk2[t_,i_]:=bshiftlist[[i]]+Rmaxlist[[i]]*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kdfix)*(1-E^(-(ka*CanalyteConc[[i]]+kdfix)*(t+tstartlist[[i]])));
RTdisNonregenkdbk2[t_,i_]:=Rmaxlist[[i]]*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kdfix)*(1-E^(-(ka*CanalyteConc[[i]]+kdfix)*(t0+tstartlist[[i]])))*E^(-kdfix*(t-t0));
(*(With regeneration, fixed off rate, with bulk shift)*)
RTRegenkdbk2[t_,i_]:=bshiftlist[[i]]+Rmaxlist[[i]]*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kdfix)*(1-E^(-(ka*CanalyteConc[[i]]+kdfix)*(t-tstartall)));
RTdisRegenkdbk2[t_,i_]:=Rmaxlist[[i]]*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kdfix)*(1-E^(-(ka*CanalyteConc[[i]]+kdfix)*(t0-tstartall)))*E^(-kdfix*(t-t0));
(*(Without regeneration, global Rmax)*)
RTNoregenGlobal[t_,i_]:=Rmaxglobal*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kd)*(1-E^(-(ka*CanalyteConc[[i]]+kd)*(t+tstartlist[[i]])));
RTdisNonregenGlobal[t_,i_]:=Rmaxglobal*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kd)*(1-E^(-(ka*CanalyteConc[[i]]+kd)*(t0+tstartlist[[i]])))*E^(-kd*(t-t0));
(*(With regeneration, global Rmax)*)
RTRegenGlobal[t_,i_]:=Rmaxglobal*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kd)*(1-E^(-(ka*CanalyteConc[[i]]+kd)*(t-tstartall)));
RTdisRegenGlobal[t_,i_]:=Rmaxglobal*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kd)*(1-E^(-(ka*CanalyteConc[[i]]+kd)*(t0-tstartall)))*E^(-kd*(t-t0));
(*(Without regeneration, global Rmax, fixed off rate)*)
RTNoregenkdGlobal[t_,i_]:=Rmaxglobal*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kdfix)*(1-E^(-(ka*CanalyteConc[[i]]+kdfix)*(t+tstartlist[[i]])));
RTdisNonregenkdGlobal[t_,i_]:=Rmaxglobal*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kdfix)*(1-E^(-(ka*CanalyteConc[[i]]+kdfix)*(t0+tstartlist[[i]])))*E^(-kdfix*(t-t0));
(*(With regeneration, global Rmax, fixed off rate)*)RTRegenkdGlobal[t_,i_]:=Rmaxglobal*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kdfix)*(1-E^(-(ka*CanalyteConc[[i]]+kdfix)*(t-tstartall)));
RTdisRegenkdGlobal[t_,i_]:=Rmaxglobal*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kdfix)*(1-E^(-(ka*CanalyteConc[[i]]+kdfix)*(t0-tstartall)))*E^(-kdfix*(t-t0));
(*(Without regeneration, global Rmax, with shift)*)
RTNoregenbkGlobal[t_,i_]:=Rmaxglobal*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kd)*(1-E^(-(ka*CanalyteConc[[i]]+kd)*(t+tstartlist[[i]])));
RTdisNonregenbkGlobal[t_,i_]:=(Rmaxglobal+shiftlist[[i]])*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kd)*(1-E^(-(ka*CanalyteConc[[i]]+kd)*(t0+tstartlist[[i]])))*E^(-kd*(t-t0));
(*(With regeneration, global Rmax, with shift)*)
RTRegenbkGlobal[t_,i_]:=Rmaxglobal*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kd)*(1-E^(-(ka*CanalyteConc[[i]]+kd)*(t-tstartall)));
RTdisRegenbkGlobal[t_,i_]:=(Rmaxglobal+shiftlist[[i]])*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kd)*(1-E^(-(ka*CanalyteConc[[i]]+kd)*(t0-tstartall)))*E^(-kd*(t-t0));(*(Without regeneration, global Rmax, with bulk shift)*)
RTNoregenbkGlobal2[t_,i_]:=bshiftlist[[i]]+Rmaxglobal*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kd)*(1-E^(-(ka*CanalyteConc[[i]]+kd)*(t+tstartlist[[i]])));
RTdisNonregenbkGlobal2[t_,i_]:=Rmaxglobal*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kd)*(1-E^(-(ka*CanalyteConc[[i]]+kd)*(t0+tstartlist[[i]])))*E^(-kd*(t-t0));
(*(With regeneration, global Rmax, with bulk shift)*)
RTRegenbkGlobal2[t_,i_]:=bshiftlist[[i]]+Rmaxglobal*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kd)*(1-E^(-(ka*CanalyteConc[[i]]+kd)*(t-tstartall)));
RTdisRegenbkGlobal2[t_,i_]:=Rmaxglobal*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kd)*(1-E^(-(ka*CanalyteConc[[i]]+kd)*(t0-tstartall)))*E^(-kd*(t-t0));
(*(Without regeneration, global Rmax, fixed off rate, with shift)*)
RTNoregenkdbkGlobal[t_,i_]:=Rmaxglobal*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kdfix)*(1-E^(-(ka*CanalyteConc[[i]]+kdfix)*(t+tstartlist[[i]])));
RTdisNonregenkdbkGlobal[t_,i_]:=(Rmaxglobal+shiftlist[[i]])*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kdfix)*(1-E^(-(ka*CanalyteConc[[i]]+kdfix)*(t0+tstartlist[[i]])))*E^(-kdfix*(t-t0));
(*(With regeneration, global Rmax, fixed off rate, with shift)*)RTRegenkdbkGlobal[t_,i_]:=Rmaxglobal*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kdfix)*(1-E^(-(ka*CanalyteConc[[i]]+kdfix)*(t-tstartall)));
RTdisRegenkdbkGlobal[t_,i_]:=(Rmaxglobal+shiftlist[[i]])*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kdfix)*(1-E^(-(ka*CanalyteConc[[i]]+kdfix)*(t0-tstartall)))*E^(-kdfix*(t-t0));(*(Without regeneration, global Rmax, fixed off rate, with bulk shift)*)
RTNoregenkdbkGlobal2[t_,i_]:=bshiftlist[[i]]+Rmaxglobal*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kdfix)*(1-E^(-(ka*CanalyteConc[[i]]+kdfix)*(t+tstartlist[[i]])));
RTdisNonregenkdbkGlobal2[t_,i_]:=Rmaxglobal*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kdfix)*(1-E^(-(ka*CanalyteConc[[i]]+kdfix)*(t0+tstartlist[[i]])))*E^(-kdfix*(t-t0));
(*(With regeneration, global Rmax, fixed off rate, with bulk shift)*)RTRegenkdbkGlobal2[t_,i_]:=bshiftlist[[i]]+Rmaxglobal*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kdfix)*(1-E^(-(ka*CanalyteConc[[i]]+kdfix)*(t-tstartall)));
RTdisRegenkdbkGlobal2[t_,i_]:=Rmaxglobal*ka*CanalyteConc[[i]]/(ka*CanalyteConc[[i]]+kdfix)*(1-E^(-(ka*CanalyteConc[[i]]+kdfix)*(t0-tstartall)))*E^(-kdfix*(t-t0));
gridpath=SystemDialogInput["FileOpen",WindowTitle->"Please open a file containing sample information"];
Quiet[While[FileFormat[gridpath]!="CSV"&&FileFormat[gridpath]!="XLS"&&FileFormat[gridpath]!="XLSX",tmpgridpath=DirectoryName[gridpath];gridpath=SystemDialogInput["FileOpen",tmpgridpath,WindowTitle->"Not an acceptable format, please open CSV file or excel workbook"]]];
gridfile=Quiet[Import[gridpath,"Data"]];
gridfileunwrap=Quiet[If[FileFormat[gridpath]=="CSV",gridfile,gridfile[[1]]]];
gridfilenotitle=Drop[gridfileunwrap,1];
If[TrueQ[gridpath==$Canceled],tablefull="A";Print["The user didn't select any file"],If[Length[Transpose[gridfilenotitle]]!=17,tablefull="A";Print["The sample information table doesn't have the correct number of columns"],If[methodtemp=="BLI",sensorfullsep=Tuples[{Capitalize[Alphabet[]][[Range[1,8]]],Range[1,12]}];
sensorfull=Table[StringJoin[sensorfullsep[[i,1]],ToString[sensorfullsep[[i,2]]]],{i,Length[sensorfullsep]}];trayfull=Table[ToString[i],{i,100}];tablefull=SortBy[Flatten[Table[traypossep=StringSplit[StringDelete[If[NumberQ[gridfilenotitle[[i,2]]],ToString[IntegerPart[gridfilenotitle[[i,2]]]],gridfilenotitle[[i,2]]]," "],","];traypos=Flatten[Table[If[StringFreeQ[traypossep[[i]],"-"]==False&&StringLength[traypossep[[i]]]>=3&&NumberQ[ToExpression[StringSplit[traypossep[[i]],"-"][[1]]]]&&NumberQ[ToExpression[StringSplit[traypossep[[i]],"-"][[2]]]],IntegerString[Range[ToExpression[StringSplit[traypossep[[i]],"-"][[1]]],ToExpression[StringSplit[traypossep[[i]],"-"][[2]]]]],If[NumberQ[ToExpression[traypossep[[i]]]],ToString[ToExpression[traypossep[[i]]]],traypossep[[i]]]],{i,Length[traypossep]}]];sensorpossep=StringSplit[StringDelete[If[NumberQ[gridfilenotitle[[i,3]]],ToString[IntegerPart[gridfilenotitle[[i,3]]]],gridfilenotitle[[i,3]]]," "],","];sensorpos=If[StringFreeQ[ToString[gridfilenotitle[[i,3]]],"All"]==False,sensorfull,Flatten[Table[If[StringFreeQ[sensorpossep[[i]],"-"]==False&&StringLength[sensorpossep[[i]]]>=5&&LetterQ[StringTake[StringSplit[sensorpossep[[i]],"-"][[1]],1]]&&LetterQ[StringTake[StringSplit[sensorpossep[[i]],"-"][[2]],1]]&&NumberQ[ToExpression[StringDrop[StringSplit[sensorpossep[[i]],"-"][[1]],1]]]&&NumberQ[ToExpression[StringDrop[StringSplit[sensorpossep[[i]],"-"][[2]],1]]],inditupletemp=Tuples[{CharacterRange[ToUpperCase[StringTake[StringSplit[sensorpossep[[i]],"-"][[1]],1]],ToUpperCase[StringTake[StringSplit[sensorpossep[[i]],"-"][[2]],1]]],Range[ToExpression[StringDrop[StringSplit[sensorpossep[[i]],"-"][[1]],1]],ToExpression[StringDrop[StringSplit[sensorpossep[[i]],"-"][[2]],1]]]}];Table[StringJoin[inditupletemp[[i,1]],ToString[inditupletemp[[i,2]]]],{i,Length[inditupletemp]}],If[StringLength[sensorpossep[[i]]]>1&&LetterQ[StringTake[sensorpossep[[i]],1]]&&NumberQ[ToExpression[StringDrop[sensorpossep[[i]],1]]],StringJoin[ToUpperCase[StringTake[sensorpossep[[i]],1]],ToString[ToExpression[StringDrop[sensorpossep[[i]],1]]]],ToUpperCase[sensorpossep[[i]]]]],{i,Length[sensorpossep]}]]];
concgridsep=If[NumberQ[gridfilenotitle[[i,11]]],gridfilenotitle[[i,11]],StringSplit[StringDelete[gridfilenotitle[[i,11]]," "],","]];
concgrid=If[NumberQ[concgridsep],{concgridsep},Table[If[NumberQ[Internal`StringToDouble[concgridsep[[i]]]]==False,concgridsep[[i]],If[Internal`StringToDouble[concgridsep[[i]]]==0&&NumberQ[ToExpression[concgridsep[[i]]]]==False,concgridsep[[i]],If[SubsetQ[Join[{"+","-",".","E","e"},IntegerString[Range[0,9]]],Characters[concgridsep[[i]]]]==False||StringCount[concgridsep[[i]],"E",IgnoreCase->True]>1,concgridsep[[i]],Internal`StringToDouble[concgridsep[[i]]]]]],{i,Length[concgridsep]}]];
concgridinclsep=If[NumberQ[gridfilenotitle[[i,12]]],gridfilenotitle[[i,12]],StringSplit[StringDelete[gridfilenotitle[[i,12]]," "],","]];
concdridincl=If[NumberQ[concgridinclsep],{concgridinclsep},If[StringFreeQ[gridfilenotitle[[i,12]],"All"]==False,concgrid,Table[If[NumberQ[Internal`StringToDouble[concgridinclsep[[i]]]]==False,concgridinclsep[[i]],If[Internal`StringToDouble[concgridinclsep[[i]]]==0&&NumberQ[ToExpression[concgridinclsep[[i]]]]==False,concgridinclsep[[i]],If[SubsetQ[Join[{"+","-",".","E","e"},IntegerString[Range[0,9]]],Characters[concgridinclsep[[i]]]]==False||StringCount[concgridinclsep[[i]],"E",IgnoreCase->True]>1,concgridinclsep[[i]],Internal`StringToDouble[concgridinclsep[[i]]]]]],{i,Length[concgridinclsep]}]]];
tupletemp=Tuples[{{gridfilenotitle[[i,1]]},traypos}];Table[Flatten[{tupletemp[[j]],{sensorpos},gridfilenotitle[[i,Range[4,10]]],{concgrid},{concdridincl},gridfilenotitle[[i,Range[13,17]]]},1],{j,Length[tupletemp]}],
{i,Length[gridfilenotitle]}],1],StringLength[#[[2]]]&&#[[2]]&];If[AllTrue[Select[Flatten[tablefull[[All,11]]],NumberQ[#]&],#>=0&]&&AllTrue[Flatten[tablefull[[All,11]]],NumberQ[#]||#=="NA"&]&&AllTrue[Flatten[tablefull[[All,12]]],NumberQ[#]||#=="NA"&]&&AllTrue[tablefull[[All,1]],MemberQ[{"Y","N"},#]&]&&AllTrue[tablefull[[All,13]],MemberQ[{"Y","N"},#]&]&&AllTrue[tablefull[[All,14]],MemberQ[{"Y","N"},#]&]&&AllTrue[tablefull[[All,16]],MemberQ[{"Y","N"},#]&]&&AllTrue[tablefull[[All,17]],MemberQ[{"Y","N"},#]&]&&AllTrue[tablefull[[All,2]],MemberQ[trayfull,#]&]&&AllTrue[Flatten[tablefull[[All,3]]],MemberQ[sensorfull,#]&]&&AllTrue[tablefull[[All,6]],NumberQ[#]&]&&AllTrue[tablefull[[All,7]],NumberQ[#]&]&&AllTrue[tablefull[[All,8]],NumberQ[#]&]&&AllTrue[tablefull[[All,9]],NumberQ[#]&]&&AllTrue[tablefull[[All,10]],NumberQ[#]&]&&AllTrue[tablefull[[All,15]],NumberQ[#]&]&&AllTrue[tablefull,SubsetQ[#[[11]],#[[12]]]&]&&AllTrue[tablefull,Length[#[[3]]]==Length[#[[11]]]&],tmpdatapath=DirectoryName[gridpath];prefix="Prefix here (no quotation marks)";DialogInput[{"Please write down the prefix for all data folders",InputField[Dynamic[prefix]],DefaultButton[DialogReturn[{}]]}];If[AllTrue[Flatten[Table[Tuples[{{tablefull[[i,2]]},If[Length[tablefull[[i,3]]]==1,{tablefull[[i,3]]},tablefull[[i,3]]]}],{i,Length[tablefull]}],1],FileExistsQ[StringJoin[tmpdatapath,ToString[prefix]," Tray ",#[[1]],"\\",#[[2]],"Results.txt"]]&],tablefullincl=DeleteCases[tablefull,{"N",_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_}];filenamenodup=DeleteDuplicates[tablefullincl[[All,{2,3}]]];
repeatcount=Flatten[Table[Table[i,{i,Count[tablefullincl[[All,{2,3}]],filenamenodup[[j]]]}],{j,Length[filenamenodup]}]];
filepos=Flatten[Table[Table[j,{i,Count[tablefullincl[[All,{2,3}]],filenamenodup[[j]]]}],{j,Length[filenamenodup]}]];
tablefullinclwinfo=Transpose[Join[Transpose[tablefullincl],{repeatcount},{filepos}]];datapath=Table[0,{i,Length[filenamenodup]}];Table[datapath[[i]]=Table[StringJoin[tmpdatapath,ToString[prefix]," Tray ",filenamenodup[[i,1]],"\\",filenamenodup[[i,2,j]],"Results.txt"],{j,Length[filenamenodup[[i,2]]]}],{i,Length[filenamenodup]}];datafile=Table[0,{i,Length[filenamenodup]}];
Print["Please wait for BLI data reading"];Table[datafile[[i]]=Table[0,{j,Length[filenamenodup[[i,2]]]}];Table[sensorrawtemp=Import[datapath[[i,j]],"Data"];datafile[[i,j]]=If[Length[sensorrawtemp]>8,If[Length[sensorrawtemp[[9]]]>=2,If[AllTrue[Drop[sensorrawtemp[[All,1]],8],NumberQ[#]&]&&AllTrue[Drop[sensorrawtemp[[All,2]],8],NumberQ[#]&],Drop[sensorrawtemp,8][[All,{1,2}]],"0"],"0"],"0"],{j,Length[filenamenodup[[i,2]]]}],{i,Length[filenamenodup]}];
Print["BLI data reading complete"];If[AllTrue[datafile,SubsetQ[#,{"0"}]==False&],hertzstring="5Hz";DialogInput[{"Please select data collection speed used in assay",PopupMenu[
Dynamic[hertzstring],{"2Hz","5Hz","10Hz"}],DefaultButton[DialogReturn[{}]]}];hertzrate=If[hertzstring=="10Hz",10,If[hertzstring=="5Hz",5,2]];kdfixa=1;kdfixb=-7;DialogInput[{"Please define the cutoff value for off rate",Row[{InputField[Dynamic[kdfixa],FieldSize->5,BaselinePosition->Top],Panel["x10",FrameMargins->None,BaselinePosition->Top],InputField[Dynamic[kdfixb],FieldSize->5]}],DefaultButton[DialogReturn[{}]]}];
While[NumberQ[Internal`StringToDouble[StringJoin[ToString[kdfixa],"E",ToString[kdfixb]]]]==False||TrueQ[Internal`StringToDouble[StringJoin[ToString[kdfixa],"E",ToString[kdfixb]]]<=0]||TrueQ[Internal`StringToDouble[StringJoin[ToString[kdfixa],"E",ToString[kdfixb]]]>0.0001]||NumberQ[kdfixa]==False||NumberQ[kdfixb]==False,DialogInput[{"Value not accepted, please redefine",Row[{InputField[Dynamic[kdfixa],FieldSize->5,BaselinePosition->Top],Panel["x10",FrameMargins->None,BaselinePosition->Top],InputField[Dynamic[kdfixb],FieldSize->5]}],DefaultButton[DialogReturn[{}]]}]];
kdfix=Internal`StringToDouble[StringJoin[ToString[kdfixa],"E",ToString[kdfixb]]];allplot=Table[0,{i,Length[tablefullinclwinfo]}];allparatable=Table[0,{i,Length[tablefullinclwinfo]}];
allparatableprint=Table[0,{i,Length[tablefullinclwinfo]}];
allparareport=Table[0,{i,Length[tablefullinclwinfo]}];allresidueplot=Table[0,{i,Length[tablefullinclwinfo]}];allresponseplot=Table[0,{i,Length[tablefullinclwinfo]}];allresponsetable=Table[0,{i,Length[tablefullinclwinfo]}];allauc=Table[0,{i,Length[tablefullinclwinfo]}];paratoinit="ka";DialogInput[{"Default to be ka; if off rate fitting is less than ideal, change to kd",PopupMenu[
Dynamic[paratoinit],{"ka","kd"}],DefaultButton[DialogReturn[{}]]}];
parakakd=If[paratoinit=="ka",{{ka,10000},kd},{ka,{kd,0.00001}}];includeassobkstring="NO";DialogInput[{"Please indicate whether to account for association bulk shift",PopupMenu[
Dynamic[includeassobkstring],{"YES","NO"}],DefaultButton[DialogReturn[{}]]}];includeassobk=If[includeassobkstring=="YES",1,0];timelimitstring="120 seconds";DialogInput[{"Please select max time allowed for each analysis",PopupMenu[
Dynamic[timelimitstring],{"60 seconds","120 seconds","240 seconds"}],DefaultButton[DialogReturn[{}]]}];timelimit=If[timelimitstring=="60 seconds",30,If[timelimitstring=="120 seconds",60,120]];plotlimitstring="300 seconds";DialogInput[{"Please select minimum plotting window for dissociation",PopupMenu[
Dynamic[plotlimitstring],{"100 seconds","300 seconds","600 seconds","900 seconds"}],DefaultButton[DialogReturn[{}]]}];plotlimit=If[plotlimitstring=="100 seconds",100,If[plotlimitstring=="300 seconds",300,If[plotlimitstring=="600 seconds",600,900]]];mm=1;Print[Row[{ProgressIndicator[Dynamic[mm-1],{0,Length[tablefullinclwinfo]}]," Finished analyzing ",Dynamic[ToString[mm-1]]," of ", ToString[Length[tablefullinclwinfo]]," samples"}]];For[mm=1,mm<=Length[tablefullinclwinfo],mm++,titrationdatatemp=datafile[[tablefullinclwinfo[[mm,19]]]];allbase=Table[If[titrationdatatemp[[i,1,1]]<tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]],Mean[Select[titrationdatatemp[[i]],#[[1]]<tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]&][[All,2]]],titrationdatatemp[[i,1,2]]],{i,Length[titrationdatatemp]}];minbase=Min[allbase];If[tablefullinclwinfo[[mm,16]]=="N"||tablefullinclwinfo[[mm,6]]==0,titrationdataraw=titrationdatatemp, If[tablefullinclwinfo[[mm,14]]=="Y",titrationdataraw=Table[Transpose[{titrationdatatemp[[i,All,1]],titrationdatatemp[[i,All,2]]-allbase[[i]]}],{i,Length[titrationdatatemp]}],titrationdataraw=Table[Transpose[{titrationdatatemp[[i,All,1]],titrationdatatemp[[i,All,2]]-minbase}],{i,Length[titrationdatatemp]}]]];sortedinclconc=DeleteDuplicates[DeleteCases[DeleteCases[Sort[tablefullinclwinfo[[mm,12]]],0.0],"NA"]];inclconcpos=Flatten[Table[Position[tablefullinclwinfo[[mm,11]],sortedinclconc[[i]]][[1]],{i,Length[sortedinclconc]}]];
If[SubsetQ[tablefullinclwinfo[[mm,11]],{0.0}]==False,titrationdatasorted=titrationdataraw[[inclconcpos]],zeropos=Flatten[Position[tablefullinclwinfo[[mm,11]],0.0]][[1]];titrationdatasorted=Table[Transpose[{titrationdataraw[[i,All,1]],titrationdataraw[[i,All,2]]-titrationdataraw[[zeropos,All,2]]}],{i,inclconcpos}]];maxconcnum=5;If[Length[titrationdatasorted]<=maxconcnum||AllTrue[titrationdatasorted,Min[Select[#[[All,1]],NumberQ[#]&]]>tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]]-5||Max[Select[#[[All,1]],NumberQ[#]&]]<tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]]-10&],titrationdataselecttemp=titrationdatasorted;CanalyteConc=sortedinclconc,singletitrationresponse=Table[Mean[Select[titrationdatasorted[[j]],#[[1]]<=tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]]-5&&#[[1]]>=tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]]-10&][[All,2]]],{j,1,Length[titrationdatasorted]}];singletitrationresponsediff=Join[{singletitrationresponse[[1]]},Table[singletitrationresponse[[j+1]]-singletitrationresponse[[j]],{j,1,Length[titrationdatasorted]-1}]];
singletitrationresponsewindow=Table[Total[singletitrationresponsediff[[Range[j,maxconcnum-1+j]]]],{j,1,Length[titrationdatasorted]-(maxconcnum-1)}];
maxtitrationposition=Position[singletitrationresponsewindow,Max[singletitrationresponsewindow]][[1,1]]+maxconcnum-1;titrationdataselecttemp=titrationdatasorted[[Range[maxtitrationposition-maxconcnum+1,maxtitrationposition]]];CanalyteConc=sortedinclconc[[Range[maxtitrationposition-maxconcnum+1,maxtitrationposition]]]];titrationdataselect=Table[First/@Partition[titrationdataselecttemp[[i]],hertzrate],{i,Length[titrationdataselecttemp]}];singledatatofit=Flatten[Table[{If[titrationdataselect[[i,j,1]]<tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]],1,0],If[titrationdataselect[[i,j,1]]<tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]],0,1],titrationdataselect[[i,j,1]],i,titrationdataselect[[i,j,2]]},{i,Dimensions[titrationdataselect][[1]]},{j,1,Dimensions[titrationdataselect][[2]]}],1];singledatatofitnoempty =Select[Select[singledatatofit,#[[1]]>=0&],(#[[3]]>=tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,9]]&&#[[3]]<=tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]])||(#[[3]]>=tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]]+tablefullinclwinfo[[mm,10]]&&#[[3]]<=tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]]+tablefullinclwinfo[[mm,8]])&];
singledatatofitnoemptyplot =Select[Select[singledatatofit,#[[1]]>=0&],#[[3]]>=tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]&&#[[3]]<=tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]]+If[plotlimit>tablefullinclwinfo[[mm,8]],plotlimit,tablefullinclwinfo[[mm,8]]]&];If[Length[singledatatofitnoempty]<1,parametertable=If[tablefullinclwinfo[[mm,17]]=="Y",Transpose[{{"Parameter","Rmax Global","ka","kd"},{"Value","NA","NA","NA"},{"StdErr","NA","NA","NA"}}],Transpose[{{"Parameter","Rmax 1","Rmax 2","Rmax 3","Rmax 4","Rmax 5","ka","kd"},{"Value","NA","NA","NA","NA","NA","NA","NA"},{"StdErr","NA","NA","NA","NA","NA","NA","NA"}}]];allparatable[[mm]]=parametertable;allparatableprint[[mm]]=parametertable;allparareport[[mm]]=Table["NA",{i,18}];allresidueplot[[mm]]=ListPlot[{0,0},ImageSize->Medium, BaseStyle->{FontSize->15},Frame->True,FrameLabel->{{"Response (nm)",None},{"Time (S)",None}}];allresponseplot[[mm]]=ListPlot[{0,0},ImageSize->Medium,  BaseStyle->{FontSize->15},Frame->True,FrameLabel->{{"Response (nm)",None},{"Concentration (nM)",None}}];allauc[[mm]]=0;allplot[[mm]]=ListPlot[singledatatofitnoemptyplot[[All,{3,5}]],GridLines->{{{tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]],Red},{tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]],Red},{tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]]+tablefullinclwinfo[[mm,8]],Red}},None},ImageSize->Medium, BaseStyle->{FontSize->15},Frame->True,FrameLabel->{{"Response (nm)",None},{"Time (S)",None}}],ymax=Max[singledatatofitnoemptyplot[[All,5]]]*1.1;ymin=If[Min[singledatatofitnoemptyplot[[All,5]]]>=0,0,Min[singledatatofitnoemptyplot[[All,5]]]*1.1];t0=tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]];
tstartall=tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]];If[tablefullinclwinfo[[mm,17]]=="Y",nonsensefitglobal=Quiet[NonlinearModelFit[{{1,0,1,1,1}},{asc*RTRegenGlobal[t,ii]+dis*RTdisRegenGlobal[t,ii],Rmaxglobal<400},{Rmaxglobal,{ka,10000},kd},{asc,dis,t,ii}, MaxIterations->20000]];
nonsensefitbkglobal=Quiet[NonlinearModelFit[{{1,0,1,1,1}},{asc*RTRegenbkGlobal[t,ii]+dis*RTdisRegenbkGlobal[t,ii],Rmaxglobal<400},Join[{Rmaxglobal},Transpose[{shiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{{ka,10000},kd}],{asc,dis,t,ii}, MaxIterations->20000]];nonsensefitbkglobal2=Quiet[NonlinearModelFit[{{1,0,1,1,1}},{asc*RTRegenbkGlobal2[t,ii]+dis*RTdisRegenbkGlobal2[t,ii],Rmaxglobal<400},Join[{Rmaxglobal},Transpose[{bshiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{{ka,10000},kd}],{asc,dis,t,ii}, MaxIterations->20000]];If[tablefullinclwinfo[[mm,13]]=="Y",If[includeassobk==1,multifittemp= If[tablefullinclwinfo[[mm,14]]=="Y",Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenbkGlobal2[t,ii]+dis*RTdisRegenbkGlobal2[t,ii]},Join[{Rmaxglobal},Transpose[{bshiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefitbkglobal2]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenbkGlobal2[t,ii]+dis*RTdisNonregenbkGlobal2[t,ii]},Join[{Rmaxglobal},tstartlist[[Range[Length[CanalyteConc]]]],Transpose[{bshiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefitbkglobal2]]];
If[Quiet[Reverse[multifittemp["BestFitParameters"]][[1,2]]]>=kdfix,multifit=multifittemp;useless=0,multifit=If[tablefullinclwinfo[[mm,14]]=="Y",Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenkdbkGlobal2[t,ii]+dis*RTdisRegenkdbkGlobal2[t,ii]},Join[{Rmaxglobal},Transpose[{bshiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefitbkglobal2]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenkdbkGlobal2[t,ii]+dis*RTdisNonregenkdbkGlobal2[t,ii]},Join[{Rmaxglobal},tstartlist[[Range[Length[CanalyteConc]]]],Transpose[{bshiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefitbkglobal2]]]],multifittemp= If[tablefullinclwinfo[[mm,14]]=="Y",Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenbkGlobal[t,ii]+dis*RTdisRegenbkGlobal[t,ii]},Join[{Rmaxglobal},Transpose[{shiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefitbkglobal]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenbkGlobal[t,ii]+dis*RTdisNonregenbkGlobal[t,ii]},Join[{Rmaxglobal},tstartlist[[Range[Length[CanalyteConc]]]],Transpose[{shiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefitbkglobal]]];
If[Quiet[Reverse[multifittemp["BestFitParameters"]][[1,2]]]>=kdfix,multifit=multifittemp;useless=0,multifit=If[tablefullinclwinfo[[mm,14]]=="Y",Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenkdbkGlobal[t,ii]+dis*RTdisRegenkdbkGlobal[t,ii]},Join[{Rmaxglobal},Transpose[{shiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefitbkglobal]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenkdbkGlobal[t,ii]+dis*RTdisNonregenkdbkGlobal[t,ii]},Join[{Rmaxglobal},tstartlist[[Range[Length[CanalyteConc]]]],Transpose[{shiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefitbkglobal]]]]],multifittemp= If[tablefullinclwinfo[[mm,14]]=="Y",Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenGlobal[t,ii]+dis*RTdisRegenGlobal[t,ii],Rmaxglobal<400},Join[{Rmaxglobal},parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefitglobal]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenGlobal[t,ii]+dis*RTdisNonregenGlobal[t,ii]},Join[{Rmaxglobal},tstartlist[[Range[Length[CanalyteConc]]]],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefitglobal]]];
If[Quiet[Reverse[multifittemp["BestFitParameters"]][[1,2]]]>=kdfix,multifit=multifittemp;useless=0,multifit=If[tablefullinclwinfo[[mm,14]]=="Y",Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenkdGlobal[t,ii]+dis*RTdisRegenkdGlobal[t,ii]},{Rmaxglobal,ka},{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefitglobal]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenkdGlobal[t,ii]+dis*RTdisNonregenkdGlobal[t,ii]},Join[{Rmaxglobal},tstartlist[[Range[Length[CanalyteConc]]]],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefitglobal]]]]];parametertable=Transpose[{{"Parameter","Rmax Global","ka","kd","KD"},{"Value","NA","NA","NA","NA"},{"StdErr","NA","NA","NA","NA"}}];If[MatchQ[Quiet[multifit["ParameterTable"]],Missing[]]==False,tempparatable=Quiet[multifit["ParameterTable"]][[1,1]];parametertable[[2,{2,3}]]=tempparatable[[2,{2,3}]];If[MatchQ[tempparatable[[-1,1]],kd],parametertable[[{-3,-2},{2,3}]]=tempparatable[[{-2,-1},{2,3}]];parametertable[[-1,2]]=tempparatable[[-1,2]]/tempparatable[[-2,2]];parametertable[[-1,3]]=tempparatable[[-1,2]]/tempparatable[[-2,2]]*Sqrt[(tempparatable[[-1,3]]/tempparatable[[-1,2]])^2+(tempparatable[[-2,3]]/tempparatable[[-2,2]])^2],parametertable[[-3,{2,3}]]=tempparatable[[-1,{2,3}]];parametertable[[-2,2]]=kdfix;parametertable[[-1,2]]=kdfix/tempparatable[[-1,2]]]];allparatable[[mm]]=parametertable;allparatableprint[[mm]]=Join[{parametertable[[1]]},Table[If[i<3,{parametertable[[i,1]],NumberForm[parametertable[[i,2]],{\[Infinity],2}],NumberForm[parametertable[[i,3]],{\[Infinity],2}]},{parametertable[[i,1]],ScientificForm[parametertable[[i,2]],4],ScientificForm[parametertable[[i,3]],4]}],{i,2,Length[parametertable]}]];allparareport[[mm]]=Join[{"NA","NA","NA","NA","NA","NA","NA","NA","NA","NA"},Flatten[Drop[parametertable[[All,{2,3}]],1]]],
nonsensefit=Quiet[NonlinearModelFit[{{1,0,1,1,1}},Join[{asc*RTRegen[t,ii]+dis*RTdisRegen[t,ii]},Table[ToExpression[StringJoin[ToString[Rmaxlist[[i]]],"<400"]],{i,Length[CanalyteConc]}]],Join[Rmaxlist[[Range[Length[CanalyteConc]]]],{{ka,10000},kd}],{asc,dis,t,ii}, MaxIterations->20000]];
nonsensefitbk=Quiet[NonlinearModelFit[{{1,0,1,1,1}},Join[{asc*RTRegenbk[t,ii]+dis*RTdisRegenbk[t,ii]},Table[ToExpression[StringJoin[ToString[Rmaxlist[[i]]],"<400"]],{i,Length[CanalyteConc]}]],Join[Rmaxlist[[Range[Length[CanalyteConc]]]],Transpose[{shiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{{ka,10000},kd}],{asc,dis,t,ii}, MaxIterations->20000]];nonsensefitbk2=Quiet[NonlinearModelFit[{{1,0,1,1,1}},Join[{asc*RTRegenbk2[t,ii]+dis*RTdisRegenbk2[t,ii]},Table[ToExpression[StringJoin[ToString[Rmaxlist[[i]]],"<400"]],{i,Length[CanalyteConc]}]],Join[Rmaxlist[[Range[Length[CanalyteConc]]]],Transpose[{bshiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{{ka,10000},kd}],{asc,dis,t,ii}, MaxIterations->20000]];If[tablefullinclwinfo[[mm,13]]=="Y",If[includeassobk==1,multifittemp= If[tablefullinclwinfo[[mm,14]]=="Y",Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenbk2[t,ii]+dis*RTdisRegenbk2[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],Transpose[{bshiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefitbk2]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenbk2[t,ii]+dis*RTdisNonregenbk2[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],tstartlist[[Range[Length[CanalyteConc]]]],Transpose[{bshiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefitbk2]]];
If[Quiet[Reverse[multifittemp["BestFitParameters"]][[1,2]]]>=kdfix,multifit=multifittemp;useless=0,multifit=If[tablefullinclwinfo[[mm,14]]=="Y",Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenkdbk2[t,ii]+dis*RTdisRegenkdbk2[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],Transpose[{bshiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefitbk2]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenkdbk2[t,ii]+dis*RTdisNonregenkdbk2[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],tstartlist[[Range[Length[CanalyteConc]]]],Transpose[{bshiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefitbk2]]]],multifittemp= If[tablefullinclwinfo[[mm,14]]=="Y",Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenbk[t,ii]+dis*RTdisRegenbk[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],Transpose[{shiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefitbk]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenbk[t,ii]+dis*RTdisNonregenbk[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],tstartlist[[Range[Length[CanalyteConc]]]],Transpose[{shiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefitbk]]];
If[Quiet[Reverse[multifittemp["BestFitParameters"]][[1,2]]]>=kdfix,multifit=multifittemp;useless=0,multifit=If[tablefullinclwinfo[[mm,14]]=="Y",Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenkdbk[t,ii]+dis*RTdisRegenkdbk[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],Transpose[{shiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefitbk]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenkdbk[t,ii]+dis*RTdisNonregenkdbk[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],tstartlist[[Range[Length[CanalyteConc]]]],Transpose[{shiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefitbk]]]]],multifittemp= If[tablefullinclwinfo[[mm,14]]=="Y",Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,Join[{asc*RTRegen[t,ii]+dis*RTdisRegen[t,ii]},Table[ToExpression[StringJoin[ToString[Rmaxlist[[i]]],"<400"]],{i,Length[CanalyteConc]}]],Join[Rmaxlist[[Range[Length[CanalyteConc]]]],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefit]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregen[t,ii]+dis*RTdisNonregen[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],tstartlist[[Range[Length[CanalyteConc]]]],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefit]]];
If[Quiet[Reverse[multifittemp["BestFitParameters"]][[1,2]]]>=kdfix,multifit=multifittemp;useless=0,multifit=If[tablefullinclwinfo[[mm,14]]=="Y",Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenkd[t,ii]+dis*RTdisRegenkd[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefit]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenkd[t,ii]+dis*RTdisNonregenkd[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],tstartlist[[Range[Length[CanalyteConc]]]],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefit]]]]];parametertable=Transpose[{{"Parameter","Rmax 1","Rmax 2","Rmax 3","Rmax 4","Rmax 5","ka","kd","KD"},{"Value","NA","NA","NA","NA","NA","NA","NA","NA"},{"StdErr","NA","NA","NA","NA","NA","NA","NA","NA"}}];If[MatchQ[Quiet[multifit["ParameterTable"]],Missing[]]==False,tempparatable=Quiet[multifit["ParameterTable"]][[1,1]];parametertable[[1+Range[Length[CanalyteConc]],{2,3}]]=tempparatable[[1+Range[Length[CanalyteConc]],{2,3}]];If[MatchQ[tempparatable[[-1,1]],kd],parametertable[[{-3,-2},{2,3}]]=tempparatable[[{-2,-1},{2,3}]];parametertable[[-1,2]]=tempparatable[[-1,2]]/tempparatable[[-2,2]];parametertable[[-1,3]]=tempparatable[[-1,2]]/tempparatable[[-2,2]]*Sqrt[(tempparatable[[-1,3]]/tempparatable[[-1,2]])^2+(tempparatable[[-2,3]]/tempparatable[[-2,2]])^2],parametertable[[-3,{2,3}]]=tempparatable[[-1,{2,3}]];parametertable[[-2,2]]=kdfix;parametertable[[-1,2]]=kdfix/tempparatable[[-1,2]]]];allparatable[[mm]]=parametertable;allparatableprint[[mm]]=Join[{parametertable[[1]]},Table[If[i<7,{parametertable[[i,1]],NumberForm[parametertable[[i,2]],{\[Infinity],2}],NumberForm[parametertable[[i,3]],{\[Infinity],2}]},{parametertable[[i,1]],ScientificForm[parametertable[[i,2]],4],ScientificForm[parametertable[[i,3]],4]}],{i,2,Length[parametertable]}]];allparareport[[mm]]=Join[Flatten[Drop[parametertable[[All,{2,3}]],1]][[Range[1,10]]],{"NA","NA"},Flatten[Drop[parametertable[[All,{2,3}]],1]][[Range[-6,-1]]]]];aucreponselist=SortBy[Select[DeleteDuplicates[Join[Transpose[{tablefullinclwinfo[[mm,11]]*10^9,Table[Mean[Select[titrationdataraw[[j]],#[[1]]<=tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]]-5&&#[[1]]>=tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]]-15&][[All,2]]],{j,1,Length[titrationdataraw]}]}],{{0,0}}],#1[[1]]==#2[[1]]&],NumberQ[#[[1]]]&],#1&];aucreponselistselect=Select[aucreponselist,SubsetQ[CanalyteConc*10^9,{#[[1]]}]&];responsetableind = Partition[{"NA","NA","NA","NA","NA","NA","NA","NA","NA","NA"},2];Table[responsetableind[[i]]=aucreponselistselect[[i]],{i,Length[aucreponselistselect]}];allresponsetable[[mm]]=responsetableind;allauc[[mm]]=Integrate[Interpolation[aucreponselist,InterpolationOrder->1][x],{x,0,Max[aucreponselist[[All,1]]]}];
allresponseplot[[mm]]=Show[ListPlot[Transpose[{Log[10,aucreponselist[[All,1]]],aucreponselist[[All,2]]}], ImageSize->Medium,BaseStyle->{FontSize->15},Frame->True,PlotStyle->PointSize[0.02],FrameLabel->{{"Response (nm)",None},{"log(Concentration (nM))",None}},PlotRange->All],ListPlot[Select[Transpose[{Log[10,aucreponselist[[All,1]]],aucreponselist[[All,2]]}],SubsetQ[Log[10,CanalyteConc*10^9],{#[[1]]}]&], PlotStyle->Directive[Red,PointSize[0.02]]],ListPlot[Transpose[{Log[10,aucreponselist[[All,1]]],aucreponselist[[All,2]]}],PlotRange->All,Joined->True,InterpolationOrder->1]];residueplottable=Table[{titrationdataselect[[i,j,1]],If[NumberQ[titrationdataselect[[i,j,1]]]==False||titrationdataselect[[i,j,1]]<tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]||titrationdataselect[[i,j,1]]>tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]]+tablefullinclwinfo[[mm,8]],"",titrationdataselect[[i,j,2]]-If[titrationdataselect[[i,j,1]]<tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]],Quiet[multifit[1,0,titrationdataselect[[i,j,1]],i]],Quiet[multifit[0,1,titrationdataselect[[i,j,1]],i]]]]},{i,Dimensions[titrationdataselect][[1]]},{j,1,Dimensions[titrationdataselect][[2]]}];allresidueplot[[mm]]=ListPlot[residueplottable,PlotRange->{{tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]],tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]]+If[plotlimit>tablefullinclwinfo[[mm,8]],plotlimit,tablefullinclwinfo[[mm,8]]]},Automatic},ImageSize->Medium, BaseStyle->{FontSize->15},Frame->True,FrameLabel->{{"Response (nm)",None},{"Time (S)",None}}];assoplot=Quiet[{multifit[1,0,t,1],multifit[1,0,t,2],multifit[1,0,t,3],multifit[1,0,t,4],multifit[1,0,t,5]}[[Reverse[Range[Length[CanalyteConc]]]]]];
dissplot=Quiet[{multifit[0,1,t,1],multifit[0,1,t,2],multifit[0,1,t,3],multifit[0,1,t,4],multifit[0,1,t,5]}[[Reverse[Range[Length[CanalyteConc]]]]]];
bulkline=Quiet[{{{t0,multifit[1,0,t0,1]},{t0,multifit[0,1,t0,1]}},{{t0,multifit[1,0,t0,2]},{t0,multifit[0,1,t0,2]}},{{t0,multifit[1,0,t0,3]},{t0,multifit[0,1,t0,3]}},{{t0,multifit[1,0,t0,4]},{t0,multifit[0,1,t0,4]}},{{t0,multifit[1,0,t0,5]},{t0,multifit[0,1,t0,5]}}}[[Reverse[Range[Length[CanalyteConc]]]]]];allplot[[mm]]=Show[{ListPlot[singledatatofitnoemptyplot[[All,{3,5}]],PlotStyle->Gray,PlotRange->{{tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]],tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]]+If[plotlimit>tablefullinclwinfo[[mm,8]],plotlimit,tablefullinclwinfo[[mm,8]]]},{ymin,ymax}},GridLines->{{{tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]],Red},{tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]],Red},{tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]]+If[plotlimit>tablefullinclwinfo[[mm,8]],plotlimit,tablefullinclwinfo[[mm,8]]],Red}},None},ImageSize->Medium,BaseStyle->{FontSize->15},Frame->True,FrameLabel->{{"Response (nm)",None},{"Time (S)",None}}],Plot[assoplot,{t,tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]],t0},PlotRange->{{tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]],tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]]+tablefullinclwinfo[[mm,8]]},{ymin,ymax}},PlotLegends->Reverse[CanalyteConc]*10^9],Plot[dissplot,{t,t0,tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]]+tablefullinclwinfo[[mm,8]]},PlotRange->{{tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]],tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]]+tablefullinclwinfo[[mm,8]]},{ymin,ymax}}],
ListLinePlot[bulkline]}]]];temptime=StringJoin[ToString[Now[[1,1]]],"_",ToString[Now[[1,2]]],"_",ToString[Now[[1,3]]]," ",ToString[Now[[1,4]]],"_",ToString[Now[[1,5]]]];fullreport=Join[{{"Ligand","Analyte","Plate","Sensor","Fitting#","Rmax 1","Rmax 1 StdErr","Rmax 2","Rmax 2 StdErr","Rmax 3","Rmax 3 StdErr","Rmax 4","Rmax 4 StdErr","Rmax 5","Rmax 5 StdErr","Rmax Global","Rmax Global StdErr","ka","ka StdErr","kd","kd StdErr","KD","KD StdErr"}},Transpose[Join[Transpose[tablefullinclwinfo[[All,{5,4,2}]]],{Table[StringDrop[StringDrop[ToString[tablefullinclwinfo[[i,3]]],1],-1],{i,Length[tablefullinclwinfo]}]},{tablefullinclwinfo[[All,18]]},Transpose[allparareport]]]];Export[StringJoin[DirectoryName[gridpath],"Titration Analysis_BLI_Report_",temptime,".csv"],fullreport];Export[StringJoin[DirectoryName[gridpath],"Titration Analysis_BLI_Report_",temptime,".pdf"],Style[fullreport//TableForm,FontSize->15]];(*Export[StringJoin[DirectoryName[gridpath],"Titration Analysis_BLI_Report_",temptime,".jpg"],Style[fullreport//TableForm,FontSize->15]];*)nb=CreateDocument[
Table[Column[{Grid[{{allplot[[i]],allresponseplot[[i]]},{allresidueplot[[i]],Style[allparatableprint[[i]]//TableForm,ShowStringCharacters->False,FontSize->15]}},Alignment->{{Left,Top},{Top,Right}}],TextCell[Style[StringJoin[{"AUC: ",If[NumberQ[allauc[[i]]],ToString[DecimalForm[allauc[[i]]]],"0"]}],FontSize->20,ShowStringCharacters->False]],TextCell[ToString[tablefullinclwinfo[[i,5]]],"Section"],TextCell[ToString[tablefullinclwinfo[[i,4]]],"Section"]},"Center"],{i,Count[tablefull[[All,1]],"Y"]}],PrintingOptions->{"PaperSize"->{11*72,8.5*72},"PageSize"->{11*72,8.5*72}}];Export[StringJoin[DirectoryName[gridpath],"Titration Analysis_BLI_Sensorgram_",temptime,".pdf"],nb];NotebookClose[nb];Print["BLI Titration Analysis Done"],Print["NOT all data files fit the description of the information provided"]],Print["NOT all data indicated in the information provided are found"]],Print["Please correct errors in the information table"]];Print["This is the end of the BLI module"],If[methodtemp=="Carterra",platefullsep=Tuples[{Capitalize[Alphabet[]][[Range[1,8]]],Range[1,12]}];
platefull=Table[StringJoin[platefullsep[[i,1]],ToString[platefullsep[[i,2]]]],{i,Length[platefullsep]}];
blockfull=CharacterRange["1","4"];cussortstring="Use info sheet sorting";DialogInput[{"Please indicate whether to sort differently than info sheet",PopupMenu[
Dynamic[cussortstring],{"Use info sheet sorting","Sort from A1 to H12"}],DefaultButton[DialogReturn[{}]]}];cussort=If[cussortstring=="Use info sheet sorting",1,0];tablefulltemp=Flatten[Table[blockpossep=StringSplit[StringDelete[If[NumberQ[gridfilenotitle[[i,2]]],ToString[IntegerPart[gridfilenotitle[[i,2]]]],gridfilenotitle[[i,2]]]," "],","];blockpos=Flatten[Table[If[StringFreeQ[blockpossep[[i]],"All"]==False,blockfull,If[StringFreeQ[blockpossep[[i]],"-"]==False&&StringLength[blockpossep[[i]]]>=3&&NumberQ[ToExpression[StringSplit[blockpossep[[i]],"-"][[1]]]]&&NumberQ[ToExpression[StringSplit[blockpossep[[i]],"-"][[2]]]],IntegerString[Range[ToExpression[StringSplit[blockpossep[[i]],"-"][[1]]],ToExpression[StringSplit[blockpossep[[i]],"-"][[2]]]]],If[NumberQ[ToExpression[blockpossep[[i]]]],ToString[ToExpression[blockpossep[[i]]]],blockpossep[[i]]]]],{i,Length[blockpossep]}]];platepossep=StringSplit[StringDelete[If[NumberQ[gridfilenotitle[[i,3]]],ToString[IntegerPart[gridfilenotitle[[i,3]]]],gridfilenotitle[[i,3]]]," "],","];platepos=If[StringFreeQ[ToString[gridfilenotitle[[i,3]]],"All"]==False,platefull,Flatten[Table[If[StringFreeQ[platepossep[[i]],"-"]==False&&StringLength[platepossep[[i]]]>=5&&LetterQ[StringTake[StringSplit[platepossep[[i]],"-"][[1]],1]]&&LetterQ[StringTake[StringSplit[platepossep[[i]],"-"][[2]],1]]&&NumberQ[ToExpression[StringDrop[StringSplit[platepossep[[i]],"-"][[1]],1]]]&&NumberQ[ToExpression[StringDrop[StringSplit[platepossep[[i]],"-"][[2]],1]]],inditupletemp=Tuples[{CharacterRange[ToUpperCase[StringTake[StringSplit[platepossep[[i]],"-"][[1]],1]],ToUpperCase[StringTake[StringSplit[platepossep[[i]],"-"][[2]],1]]],Range[ToExpression[StringDrop[StringSplit[platepossep[[i]],"-"][[1]],1]],ToExpression[StringDrop[StringSplit[platepossep[[i]],"-"][[2]],1]]]}];Table[StringJoin[inditupletemp[[i,1]],ToString[inditupletemp[[i,2]]]],{i,Length[inditupletemp]}],If[StringLength[platepossep[[i]]]>1&&LetterQ[StringTake[platepossep[[i]],1]]&&NumberQ[ToExpression[StringDrop[platepossep[[i]],1]]],StringJoin[ToUpperCase[StringTake[platepossep[[i]],1]],ToString[ToExpression[StringDrop[platepossep[[i]],1]]]],ToUpperCase[platepossep[[i]]]]],{i,Length[platepossep]}]]];
concgridsep=If[NumberQ[gridfilenotitle[[i,11]]],gridfilenotitle[[i,11]],StringSplit[StringDelete[gridfilenotitle[[i,11]]," "],","]];
concgrid=If[NumberQ[concgridsep],{concgridsep},Table[If[NumberQ[Internal`StringToDouble[concgridsep[[i]]]]==False,concgridsep[[i]],If[Internal`StringToDouble[concgridsep[[i]]]==0&&NumberQ[ToExpression[concgridsep[[i]]]]==False,concgridsep[[i]],If[SubsetQ[Join[{"+","-",".","E","e"},IntegerString[Range[0,9]]],Characters[concgridsep[[i]]]]==False||StringCount[concgridsep[[i]],"E",IgnoreCase->True]>1,concgridsep[[i]],Internal`StringToDouble[concgridsep[[i]]]]]],{i,Length[concgridsep]}]];
concgridinclsep=If[NumberQ[gridfilenotitle[[i,12]]],gridfilenotitle[[i,12]],StringSplit[StringDelete[gridfilenotitle[[i,12]]," "],","]];
concdridincl=If[NumberQ[concgridinclsep],{concgridinclsep},If[StringFreeQ[gridfilenotitle[[i,12]],"All"]==False,concgrid,Table[If[NumberQ[Internal`StringToDouble[concgridinclsep[[i]]]]==False,concgridinclsep[[i]],If[Internal`StringToDouble[concgridinclsep[[i]]]==0&&NumberQ[ToExpression[concgridinclsep[[i]]]]==False,concgridinclsep[[i]],If[SubsetQ[Join[{"+","-",".","E","e"},IntegerString[Range[0,9]]],Characters[concgridinclsep[[i]]]]==False||StringCount[concgridinclsep[[i]],"E",IgnoreCase->True]>1,concgridinclsep[[i]],Internal`StringToDouble[concgridinclsep[[i]]]]]],{i,Length[concgridinclsep]}]]];
tupletemp=Tuples[{{gridfilenotitle[[i,1]]},blockpos,platepos}];Table[Flatten[{tupletemp[[j]],gridfilenotitle[[i,Range[4,10]]],{concgrid},{concdridincl},gridfilenotitle[[i,Range[13,17]]]},1],{j,Length[tupletemp]}],
{i,Length[gridfilenotitle]}],1];tablefull=If[cussort==1,tablefulltemp,SortBy[tablefulltemp,StringLength[#[[2]]]&&#[[2]]&&StringLength[#[[3]]]&&StringReverse[#[[3]]]&]];
If[AllTrue[Select[Flatten[tablefull[[All,11]]],NumberQ[#]&],#>=0&]&&AllTrue[Flatten[tablefull[[All,11]]],NumberQ[#]||#=="NA"&]&&AllTrue[Flatten[tablefull[[All,12]]],NumberQ[#]||#=="NA"&]&&AllTrue[tablefull[[All,1]],MemberQ[{"Y","N"},#]&]&&AllTrue[tablefull[[All,13]],MemberQ[{"Y","N"},#]&]&&AllTrue[tablefull[[All,14]],MemberQ[{"Y","N"},#]&]&&AllTrue[tablefull[[All,16]],MemberQ[{"Y","N"},#]&]&&AllTrue[tablefull[[All,17]],MemberQ[{"Y","N"},#]&]&&AllTrue[tablefull[[All,2]],MemberQ[blockfull,#]&]&&AllTrue[tablefull[[All,3]],MemberQ[platefull,#]&]&&AllTrue[tablefull[[All,6]],NumberQ[#]&]&&AllTrue[tablefull[[All,7]],NumberQ[#]&]&&AllTrue[tablefull[[All,8]],NumberQ[#]&]&&AllTrue[tablefull[[All,9]],NumberQ[#]&]&&AllTrue[tablefull[[All,10]],NumberQ[#]&]&&AllTrue[tablefull[[All,15]],NumberQ[#]&]&&AllTrue[tablefull,SubsetQ[#[[11]],#[[12]]]&],If[Length[DeleteDuplicates[tablefull[[All,{2,3}]]]]!=Length[tablefull[[All,{2,3}]]],Print["Some spots on the chip have been included more than once"],tmpdatapath=DirectoryName[gridpath];datapath=SystemDialogInput["FileOpen",tmpdatapath,WindowTitle->"Please choose the file containing Carterra data export"];Quiet[While[FileFormat[datapath]!="CSV"&&FileFormat[datapath]!="XLS"&&FileFormat[datapath]!="XLSX",tmpdatapath=DirectoryName[datapath];datapath=SystemDialogInput["FileOpen",tmpdatapath,WindowTitle->"File format incorrect, please choose CSV file or excel worksheet"]]];Print["Please wait for Carterra file reading"];datafile=Quiet[Import[datapath,"Data"]];Print["Carterra file reading finished"];
datafileunwrap=Quiet[If[FileFormat[datapath]=="CSV",datafile,datafile[[1]]]];
datafilenotitle=Drop[datafileunwrap,1];If[TrueQ[datapath==$Canceled],Print["The user didn't provide any Carterra raw data"],If[Length[datafilenotitle]==Length[Flatten[tablefull[[All,11]]]],spotgrid=SortBy[Transpose[{Range[1,384],Flatten[ConstantArray[IntegerString[Range[1,4]],384/4]],StringJoin/@Tuples[{{"A","E","B","F","C","G","D","H"},Flatten[Transpose[ConstantArray[IntegerString[Range[12]],4]]]}]}],#[[2]]&&StringLength[#[[3]]]&&StringReverse[#[[3]]]&];spotlist=SortBy[Table[Select[spotgrid,#[[2]]==tablefull[[i,2]]&&#[[3]]==tablefull[[i,3]]&][[1]],{i, Length[tablefull]}],#[[1]]&];positionfull=Flatten[SortBy[Table[ConstantArray[Select[spotgrid,#[[2]]==tablefull[[i,2]]&&#[[3]]==tablefull[[i,3]]&][[1]],Length[tablefull[[i,11]]]],{i, Length[tablefull]}],#[[1,1]]&],1];positionlist=Table[Flatten[Position[positionfull,{spotlist[[i,1]],_,_}]],{i,Length[spotlist]}];
linepoisitionlist=Flatten[Table[Position[tablefull,{_,spotlist[[i,2]],spotlist[[i,3]],_,_,_,_,_,_,_,_,_,_,_,_,_,_}],{i,Length[tablefull]}]];
tablepositionlist=Table[0,{i,Length[tablefull]}];
Table[tablepositionlist[[linepoisitionlist[[i]]]]=positionlist[[i]],{i,Length[tablefull]}];
tablefullwlinepos=DeleteCases[Transpose[Join[Transpose[tablefull],{tablepositionlist}]],{"N",_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_}];ROImapfull=Transpose[Join[Transpose[SortBy[Tuples[{blockfull,platefull}],StringTake[#[[2]],1]&&ToExpression[StringDrop[#[[2]],1]]&]],{Join[Range[1,48],Range[1,48]+96,Range[1,48]+96*2,Range[1,48]+96*3,Range[49,96],Range[49,96]+96,Range[49,96]+96*2,Range[49,96]+96*3]}]];
ROIposreport =Flatten[Table[ROImapfull[[Position[ROImapfull[[All,{1,2}]],tablefullwlinepos[[i,{2,3}]]][[1]],3]],{i,Length[tablefullwlinepos]}]];If[Dimensions[datafilenotitle][[2]]<3,Print["No more than 3"],(*A table for checking sample name*)If[AllTrue[datafilenotitle[[All,2]],NumberQ[#]&]&&AllTrue[datafilenotitle[[All,3]],NumberQ[#]&],If[AllTrue[datafilenotitle[[All,1]],StringQ[#]&],analytecheck=Table[If[AllTrue[Table[StringSplit[datafilenotitle[[i,1]],"-"][[1]],{i,tablepositionlist[[j]]}],StringMatchQ[#,StringSplit[datafilenotitle[[tablepositionlist[[j,1]],1]],"-"][[1]]]&],"SameAna","DiffAna"],{j,Length[tablepositionlist]}];If[AllTrue[analytecheck,StringMatchQ[#,"SameAna"]&],kdfixa=1;kdfixb=-5;DialogInput[{"Please define the cutoff for off rate",Row[{InputField[Dynamic[kdfixa],FieldSize->5,BaselinePosition->Top],Panel["x10",FrameMargins->None,BaselinePosition->Top],InputField[Dynamic[kdfixb],FieldSize->5]}],DefaultButton[DialogReturn[{}]]}];
While[NumberQ[Internal`StringToDouble[StringJoin[ToString[kdfixa],"E",ToString[kdfixb]]]]==False||TrueQ[Internal`StringToDouble[StringJoin[ToString[kdfixa],"E",ToString[kdfixb]]]<=0]||TrueQ[Internal`StringToDouble[StringJoin[ToString[kdfixa],"E",ToString[kdfixb]]]>0.0001]||NumberQ[kdfixa]==False||NumberQ[kdfixb]==False,DialogInput[{"Value not accepted, please redefine",Row[{InputField[Dynamic[kdfixa],FieldSize->5,BaselinePosition->Top],Panel["x10",FrameMargins->None,BaselinePosition->Top],InputField[Dynamic[kdfixb],FieldSize->5]}],DefaultButton[DialogReturn[{}]]}]];
kdfix=Internal`StringToDouble[StringJoin[ToString[kdfixa],"E",ToString[kdfixb]]];(*define equations here*)allplot=Table[0,{i,Count[tablefull[[All,1]],"Y"]}];allparatable=Table[0,{i,Count[tablefull[[All,1]],"Y"]}];allparatableprint=Table[0,{i,Count[tablefull[[All,1]],"Y"]}];
allparareport=Table[0,{i,Count[tablefull[[All,1]],"Y"]}];allresidueplot=Table[0,{i,Count[tablefull[[All,1]],"Y"]}];allresponseplot=Table[0,{i,Count[tablefull[[All,1]],"Y"]}];allresponsetable=Table[0,{i,Count[tablefull[[All,1]],"Y"]}];allauc=Table[0,{i,Count[tablefull[[All,1]],"Y"]}];paratoinit="ka";DialogInput[{"Default to be ka; if off rate fitting is less than ideal, change to kd",PopupMenu[
Dynamic[paratoinit],{"ka","kd"}],DefaultButton[DialogReturn[{}]]}];
parakakd=If[paratoinit=="ka",{{ka,10000},kd},{ka,{kd,0.00001}}];includeassobkstring="NO";DialogInput[{"Please indicate whether to account for association bulk shift",PopupMenu[
Dynamic[includeassobkstring],{"YES","NO"}],DefaultButton[DialogReturn[{}]]}];includeassobk=If[includeassobkstring=="YES",1,0];timelimitstring="120 seconds";DialogInput[{"Please select max time allowed for each analysis",PopupMenu[
Dynamic[timelimitstring],{"60 seconds","120 seconds","240 seconds"}],DefaultButton[DialogReturn[{}]]}];timelimit=If[timelimitstring=="60 seconds",30,If[timelimitstring=="120 seconds",60,120]];plotlimitstring="300 seconds";DialogInput[{"Please select minimum plotting window for dissociation",PopupMenu[
Dynamic[plotlimitstring],{"100 seconds","300 seconds","600 seconds","900 seconds"}],DefaultButton[DialogReturn[{}]]}];plotlimit=If[plotlimitstring=="100 seconds",100,If[plotlimitstring=="300 seconds",300,If[plotlimitstring=="600 seconds",600,900]]];mm=1;Print[Row[{ProgressIndicator[Dynamic[mm-1],{0,Count[tablefull[[All,1]],"Y"]}]," Finished analyzing ",Dynamic[ToString[mm-1]]," of ", ToString[Count[tablefull[[All,1]],"Y"]]," samples"}]];For[mm=1,mm<=Count[tablefull[[All,1]],"Y"],mm++,titrationdatatemp=Table[Partition[Drop[datafilenotitle[[i]],1],2],{i,tablefullwlinepos[[mm,18]]}];maxpos=Flatten[If[SubsetQ[tablefullwlinepos[[mm,11]],{"NA"}],Position[tablefullwlinepos[[mm,11]],Max[tablefullwlinepos[[mm,11]]][[1]]],Position[tablefullwlinepos[[mm,11]],Max[tablefullwlinepos[[mm,11]]]]]][[1]];
allbase=Table[If[titrationdatatemp[[i,1,1]]<tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]],Mean[Select[titrationdatatemp[[i]],#[[1]]<tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]&][[All,2]]],titrationdatatemp[[i,1,2]]],{i,Length[titrationdatatemp]}];minbase=Min[allbase];refbase=allbase[[maxpos]];If[tablefullwlinepos[[mm,16]]=="N"||tablefullwlinepos[[mm,6]]==0,titrationdataraw=titrationdatatemp, If[tablefullwlinepos[[mm,14]]=="Y"||refbase<=0,titrationdataraw=Table[Transpose[{titrationdatatemp[[i,All,1]],titrationdatatemp[[i,All,2]]-allbase[[i]]}],{i,Length[titrationdatatemp]}],titrationdataraw=Table[Transpose[{titrationdatatemp[[i,All,1]],titrationdatatemp[[i,All,2]]-minbase}],{i,Length[titrationdatatemp]}]]];
sortedinclconc=DeleteDuplicates[DeleteCases[DeleteCases[Sort[tablefullwlinepos[[mm,12]]],0.0],"NA"]];inclconcpos=Flatten[Table[Position[tablefullwlinepos[[mm,11]],sortedinclconc[[i]]][[1]],{i,Length[sortedinclconc]}]];
If[SubsetQ[tablefullwlinepos[[mm,11]],{0.0}]==False,titrationdatasorted=titrationdataraw[[inclconcpos]],zeropos=Flatten[Position[tablefullwlinepos[[mm,11]],0.0]][[1]];titrationdatasorted=Table[Transpose[{titrationdataraw[[i,All,1]],titrationdataraw[[i,All,2]]-titrationdataraw[[zeropos,All,2]]}],{i,inclconcpos}]];maxconcnum=5;If[Length[titrationdatasorted]<=maxconcnum||AllTrue[titrationdatasorted,Min[Select[#[[All,1]],NumberQ[#]&]]>tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]]-5||Max[Select[#[[All,1]],NumberQ[#]&]]<tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]]-15&],titrationdataselect=titrationdatasorted;CanalyteConc=sortedinclconc,singletitrationresponse=Table[Mean[Select[titrationdatasorted[[j]],#[[1]]<=tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]]-5&&#[[1]]>=tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]]-15&][[All,2]]],{j,1,Length[titrationdatasorted]}];singletitrationresponsediff=Join[{singletitrationresponse[[1]]},Table[singletitrationresponse[[j+1]]-singletitrationresponse[[j]],{j,1,Length[titrationdatasorted]-1}]];
singletitrationresponsewindow=Table[Total[singletitrationresponsediff[[Range[j,maxconcnum-1+j]]]],{j,1,Length[titrationdatasorted]-(maxconcnum-1)}];
maxtitrationposition=Position[singletitrationresponsewindow,Max[singletitrationresponsewindow]][[1,1]]+maxconcnum-1;titrationdataselect=titrationdatasorted[[Range[maxtitrationposition-maxconcnum+1,maxtitrationposition]]];CanalyteConc=sortedinclconc[[Range[maxtitrationposition-maxconcnum+1,maxtitrationposition]]]];singledatatofit=Flatten[Table[{If[titrationdataselect[[i,j,1]]<tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]],1,0],If[titrationdataselect[[i,j,1]]<tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]],0,1],titrationdataselect[[i,j,1]],i,titrationdataselect[[i,j,2]]},{i,Dimensions[titrationdataselect][[1]]},{j,1,Dimensions[titrationdataselect][[2]]}],1];singledatatofitnoempty =Select[Select[singledatatofit,#[[1]]>=0&],(#[[3]]>=tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,9]]&&#[[3]]<=tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]])||(#[[3]]>=tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]]+tablefullwlinepos[[mm,10]]&&#[[3]]<=tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]]+tablefullwlinepos[[mm,8]])&];
singledatatofitnoemptyplot =Select[Select[singledatatofit,#[[1]]>=0&],#[[3]]>=tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]&&#[[3]]<=tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]]+If[plotlimit>tablefullwlinepos[[mm,8]],plotlimit,tablefullwlinepos[[mm,8]]]&];If[Length[singledatatofitnoempty]<1,parametertable=If[tablefullwlinepos[[mm,17]]=="Y",Transpose[{{"Parameter","Rmax Global","ka","kd"},{"Value","NA","NA","NA"},{"StdErr","NA","NA","NA"}}],Transpose[{{"Parameter","Rmax 1","Rmax 2","Rmax 3","Rmax 4","Rmax 5","ka","kd"},{"Value","NA","NA","NA","NA","NA","NA","NA"},{"StdErr","NA","NA","NA","NA","NA","NA","NA"}}]];allparatable[[mm]]=parametertable;allparatableprint[[mm]]=parametertable;allparareport[[mm]]=Table["NA",{i,18}];allresidueplot[[mm]]=ListPlot[{0,0},ImageSize->Medium, BaseStyle->{FontSize->15},Frame->True,FrameLabel->{{"Response (RU)",None},{"Time (S)",None}}];allresponseplot[[mm]]=ListPlot[{0,0},ImageSize->Medium, BaseStyle->{FontSize->15},Frame->True,FrameLabel->{{"Response (RU)",None},{"Concentration (nM)",None}}];allauc[[mm]]=0;allplot[[mm]]=ListPlot[singledatatofitnoemptyplot[[All,{3,5}]],GridLines->{{{tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]],Red},{tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]],Red},{tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]]+tablefullwlinepos[[mm,8]],Red}},None},ImageSize->Medium,  BaseStyle->{FontSize->15},Frame->True,FrameLabel->{{"Response (RU)",None},{"Time (S)",None}}],ymax=Max[singledatatofitnoemptyplot[[All,5]]]*1.1;ymin=If[Min[singledatatofitnoemptyplot[[All,5]]]>=0,0,Min[singledatatofitnoemptyplot[[All,5]]]*1.1];t0=tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]];
tstartall=tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]];If[tablefullwlinepos[[mm,17]]=="Y",nonsensefitglobal=Quiet[NonlinearModelFit[{{1,0,1,1,1}},{asc*RTRegenGlobal[t,ii]+dis*RTdisRegenGlobal[t,ii],Rmaxglobal<400},{Rmaxglobal,{ka,10000},kd},{asc,dis,t,ii}, MaxIterations->20000]];
nonsensefitbkglobal=Quiet[NonlinearModelFit[{{1,0,1,1,1}},{asc*RTRegenbkGlobal[t,ii]+dis*RTdisRegenbkGlobal[t,ii],Rmaxglobal<400},Join[{Rmaxglobal},Transpose[{shiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{{ka,10000},kd}],{asc,dis,t,ii}, MaxIterations->20000]];nonsensefitbkglobal2=Quiet[NonlinearModelFit[{{1,0,1,1,1}},{asc*RTRegenbkGlobal2[t,ii]+dis*RTdisRegenbkGlobal2[t,ii],Rmaxglobal<400},Join[{Rmaxglobal},Transpose[{bshiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{{ka,10000},kd}],{asc,dis,t,ii}, MaxIterations->20000]];If[tablefullwlinepos[[mm,13]]=="Y",multifittemp= If[includeassobk==1,multifittemp= If[tablefullwlinepos[[mm,14]]=="Y"||refbase<=0,Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenbkGlobal2[t,ii]+dis*RTdisRegenbkGlobal2[t,ii]},Join[{Rmaxglobal},Transpose[{bshiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefitbkglobal2]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenbkGlobal2[t,ii]+dis*RTdisNonregenbkGlobal2[t,ii]},Join[{Rmaxglobal},tstartlist[[Range[Length[CanalyteConc]]]],Transpose[{bshiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefitbkglobal2]]];
If[Quiet[Reverse[multifittemp["BestFitParameters"]][[1,2]]]>=kdfix,multifit=multifittemp;useless=0,multifit=If[tablefullwlinepos[[mm,14]]=="Y"||refbase<=0,Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenkdbkGlobal2[t,ii]+dis*RTdisRegenkdbkGlobal2[t,ii]},Join[{Rmaxglobal},Transpose[{bshiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefitbkglobal2]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenkdbkGlobal2[t,ii]+dis*RTdisNonregenkdbkGlobal2[t,ii]},Join[{Rmaxglobal},tstartlist[[Range[Length[CanalyteConc]]]],Transpose[{bshiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefitbkglobal2]]]],multifittemp= If[tablefullwlinepos[[mm,14]]=="Y"||refbase<=0,Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenbkGlobal[t,ii]+dis*RTdisRegenbkGlobal[t,ii]},Join[{Rmaxglobal},Transpose[{shiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefitbkglobal]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenbkGlobal[t,ii]+dis*RTdisNonregenbkGlobal[t,ii]},Join[{Rmaxglobal},tstartlist[[Range[Length[CanalyteConc]]]],Transpose[{shiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefitbkglobal]]];
If[Quiet[Reverse[multifittemp["BestFitParameters"]][[1,2]]]>=kdfix,multifit=multifittemp;useless=0,multifit=If[tablefullwlinepos[[mm,14]]=="Y"||refbase<=0,Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenkdbkGlobal[t,ii]+dis*RTdisRegenkdbkGlobal[t,ii]},Join[{Rmaxglobal},Transpose[{shiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefitbkglobal]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenkdbkGlobal[t,ii]+dis*RTdisNonregenkdbkGlobal[t,ii]},Join[{Rmaxglobal},tstartlist[[Range[Length[CanalyteConc]]]],Transpose[{shiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefitbkglobal]]]]],multifittemp= If[tablefullwlinepos[[mm,14]]=="Y"||refbase<=0,Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenGlobal[t,ii]+dis*RTdisRegenGlobal[t,ii],Rmaxglobal<400},Join[{Rmaxglobal},parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefitglobal]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenGlobal[t,ii]+dis*RTdisNonregenGlobal[t,ii]},Join[{Rmaxglobal},tstartlist[[Range[Length[CanalyteConc]]]],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefitglobal]]];
If[Quiet[Reverse[multifittemp["BestFitParameters"]][[1,2]]]>=kdfix,multifit=multifittemp;useless=0,multifit=If[tablefullwlinepos[[mm,14]]=="Y"||refbase<=0,Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenkdGlobal[t,ii]+dis*RTdisRegenkdGlobal[t,ii]},{Rmaxglobal,ka},{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefitglobal]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenkdGlobal[t,ii]+dis*RTdisNonregenkdGlobal[t,ii]},Join[{Rmaxglobal},tstartlist[[Range[Length[CanalyteConc]]]],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefitglobal]]]]];parametertable=Transpose[{{"Parameter","Rmax Global","ka","kd","KD"},{"Value","NA","NA","NA","NA"},{"StdErr","NA","NA","NA","NA"}}];If[MatchQ[Quiet[multifit["ParameterTable"]],Missing[]]==False,tempparatable=Quiet[multifit["ParameterTable"]][[1,1]];parametertable[[2,{2,3}]]=tempparatable[[2,{2,3}]];If[MatchQ[tempparatable[[-1,1]],kd],parametertable[[{-3,-2},{2,3}]]=tempparatable[[{-2,-1},{2,3}]];parametertable[[-1,2]]=tempparatable[[-1,2]]/tempparatable[[-2,2]];parametertable[[-1,3]]=tempparatable[[-1,2]]/tempparatable[[-2,2]]*Sqrt[(tempparatable[[-1,3]]/tempparatable[[-1,2]])^2+(tempparatable[[-2,3]]/tempparatable[[-2,2]])^2],parametertable[[-3,{2,3}]]=tempparatable[[-1,{2,3}]];parametertable[[-2,2]]=kdfix;parametertable[[-1,2]]=kdfix/tempparatable[[-1,2]]]];allparatable[[mm]]=parametertable;allparatableprint[[mm]]=Join[{parametertable[[1]]},Table[If[i<3,{parametertable[[i,1]],NumberForm[parametertable[[i,2]],{\[Infinity],2}],NumberForm[parametertable[[i,3]],{\[Infinity],2}]},{parametertable[[i,1]],ScientificForm[parametertable[[i,2]],4],ScientificForm[parametertable[[i,3]],4]}],{i,2,Length[parametertable]}]];allparareport[[mm]]=Join[{"NA","NA","NA","NA","NA","NA","NA","NA","NA","NA"},Flatten[Drop[parametertable[[All,{2,3}]],1]]],
nonsensefit=Quiet[NonlinearModelFit[{{1,0,1,1,1}},Join[{asc*RTRegen[t,ii]+dis*RTdisRegen[t,ii]},Table[ToExpression[StringJoin[ToString[Rmaxlist[[i]]],"<400"]],{i,Length[CanalyteConc]}]],Join[Rmaxlist[[Range[Length[CanalyteConc]]]],{{ka,10000},kd}],{asc,dis,t,ii}, MaxIterations->20000]];
nonsensefitbk=Quiet[NonlinearModelFit[{{1,0,1,1,1}},Join[{asc*RTRegenbk[t,ii]+dis*RTdisRegenbk[t,ii]},Table[ToExpression[StringJoin[ToString[Rmaxlist[[i]]],"<400"]],{i,Length[CanalyteConc]}]],Join[Rmaxlist[[Range[Length[CanalyteConc]]]],Transpose[{shiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{{ka,10000},kd}],{asc,dis,t,ii}, MaxIterations->20000]];nonsensefitbk2=Quiet[NonlinearModelFit[{{1,0,1,1,1}},Join[{asc*RTRegenbk2[t,ii]+dis*RTdisRegenbk2[t,ii]},Table[ToExpression[StringJoin[ToString[Rmaxlist[[i]]],"<400"]],{i,Length[CanalyteConc]}]],Join[Rmaxlist[[Range[Length[CanalyteConc]]]],Transpose[{bshiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{{ka,10000},kd}],{asc,dis,t,ii}, MaxIterations->20000]];If[tablefullwlinepos[[mm,13]]=="Y",If[includeassobk==1,multifittemp= If[tablefullwlinepos[[mm,14]]=="Y"||refbase<=0,Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenbk2[t,ii]+dis*RTdisRegenbk2[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],Transpose[{bshiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefitbk2]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenbk2[t,ii]+dis*RTdisNonregenbk2[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],tstartlist[[Range[Length[CanalyteConc]]]],Transpose[{bshiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefitbk2]]];
If[Quiet[Reverse[multifittemp["BestFitParameters"]][[1,2]]]>=kdfix,multifit=multifittemp;useless=0,multifit=If[tablefullwlinepos[[mm,14]]=="Y"||refbase<=0,Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenkdbk2[t,ii]+dis*RTdisRegenkdbk2[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],Transpose[{bshiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefitbk2]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenkdbk2[t,ii]+dis*RTdisNonregenkdbk2[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],tstartlist[[Range[Length[CanalyteConc]]]],Transpose[{bshiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefitbk2]]]],multifittemp= If[tablefullwlinepos[[mm,14]]=="Y"||refbase<=0,Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenbk[t,ii]+dis*RTdisRegenbk[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],Transpose[{shiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefitbk]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenbk[t,ii]+dis*RTdisNonregenbk[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],tstartlist[[Range[Length[CanalyteConc]]]],Transpose[{shiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefitbk]]];
If[Quiet[Reverse[multifittemp["BestFitParameters"]][[1,2]]]>=kdfix,multifit=multifittemp;useless=0,multifit=If[tablefullwlinepos[[mm,14]]=="Y"||refbase<=0,Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenkdbk[t,ii]+dis*RTdisRegenkdbk[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],Transpose[{shiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefitbk]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenkdbk[t,ii]+dis*RTdisNonregenkdbk[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],tstartlist[[Range[Length[CanalyteConc]]]],Transpose[{shiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefitbk]]]]],multifittemp= If[tablefullwlinepos[[mm,14]]=="Y"||refbase<=0,Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,Join[{asc*RTRegen[t,ii]+dis*RTdisRegen[t,ii]},Table[ToExpression[StringJoin[ToString[Rmaxlist[[i]]],"<400"]],{i,Length[CanalyteConc]}]],Join[Rmaxlist[[Range[Length[CanalyteConc]]]],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefit]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregen[t,ii]+dis*RTdisNonregen[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],tstartlist[[Range[Length[CanalyteConc]]]],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefit]]];
If[Quiet[Reverse[multifittemp["BestFitParameters"]][[1,2]]]>=kdfix,multifit=multifittemp;useless=0,multifit=If[tablefullwlinepos[[mm,14]]=="Y"||refbase<=0,Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenkd[t,ii]+dis*RTdisRegenkd[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefit]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenkd[t,ii]+dis*RTdisNonregenkd[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],tstartlist[[Range[Length[CanalyteConc]]]],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefit]]]]];parametertable=Transpose[{{"Parameter","Rmax 1","Rmax 2","Rmax 3","Rmax 4","Rmax 5","ka","kd","KD"},{"Value","NA","NA","NA","NA","NA","NA","NA","NA"},{"StdErr","NA","NA","NA","NA","NA","NA","NA","NA"}}];If[MatchQ[Quiet[multifit["ParameterTable"]],Missing[]]==False,tempparatable=Quiet[multifit["ParameterTable"]][[1,1]];parametertable[[1+Range[Length[CanalyteConc]],{2,3}]]=tempparatable[[1+Range[Length[CanalyteConc]],{2,3}]];If[MatchQ[tempparatable[[-1,1]],kd],parametertable[[{-3,-2},{2,3}]]=tempparatable[[{-2,-1},{2,3}]];parametertable[[-1,2]]=tempparatable[[-1,2]]/tempparatable[[-2,2]];parametertable[[-1,3]]=tempparatable[[-1,2]]/tempparatable[[-2,2]]*Sqrt[(tempparatable[[-1,3]]/tempparatable[[-1,2]])^2+(tempparatable[[-2,3]]/tempparatable[[-2,2]])^2],parametertable[[-3,{2,3}]]=tempparatable[[-1,{2,3}]];parametertable[[-2,2]]=kdfix;parametertable[[-1,2]]=kdfix/tempparatable[[-1,2]]]];allparatable[[mm]]=parametertable;allparatableprint[[mm]]=Join[{parametertable[[1]]},Table[If[i<7,{parametertable[[i,1]],NumberForm[parametertable[[i,2]],{\[Infinity],2}],NumberForm[parametertable[[i,3]],{\[Infinity],2}]},{parametertable[[i,1]],ScientificForm[parametertable[[i,2]],4],ScientificForm[parametertable[[i,3]],4]}],{i,2,Length[parametertable]}]];allparareport[[mm]]=Join[Flatten[Drop[parametertable[[All,{2,3}]],1]][[Range[1,10]]],{"NA","NA"},Flatten[Drop[parametertable[[All,{2,3}]],1]][[Range[-6,-1]]]]];aucreponselist=SortBy[Select[DeleteDuplicates[Join[Transpose[{tablefullwlinepos[[mm,11]]*10^9,Table[Mean[Select[titrationdataraw[[j]],#[[1]]<=tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]]-5&&#[[1]]>=tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]]-15&][[All,2]]],{j,1,Length[titrationdataraw]}]}],{{0,0}}],#1[[1]]==#2[[1]]&],NumberQ[#[[1]]]&],#1&];aucreponselistselect=Select[aucreponselist,SubsetQ[CanalyteConc*10^9,{#[[1]]}]&];responsetableind = Partition[{"NA","NA","NA","NA","NA","NA","NA","NA","NA","NA"},2];Table[responsetableind[[i]]=aucreponselistselect[[i]],{i,Length[aucreponselistselect]}];allresponsetable[[mm]]=responsetableind;allauc[[mm]]=Integrate[Interpolation[aucreponselist,InterpolationOrder->1][x],{x,0,Max[aucreponselist[[All,1]]]}];
allresponseplot[[mm]]=Show[ListPlot[Transpose[{Log[10,aucreponselist[[All,1]]],aucreponselist[[All,2]]}], ImageSize->Medium,BaseStyle->{FontSize->15},Frame->True,PlotStyle->PointSize[0.02],FrameLabel->{{"Response (RU)",None},{"log(Concentration (nM))",None}},PlotRange->All],ListPlot[Select[Transpose[{Log[10,aucreponselist[[All,1]]],aucreponselist[[All,2]]}],SubsetQ[Log[10,CanalyteConc*10^9],{#[[1]]}]&], PlotStyle->Directive[Red,PointSize[0.02]]],ListPlot[Transpose[{Log[10,aucreponselist[[All,1]]],aucreponselist[[All,2]]}],PlotRange->All,Joined->True,InterpolationOrder->1]];residueplottable=Table[{titrationdataselect[[i,j,1]],If[NumberQ[titrationdataselect[[i,j,1]]]==False||titrationdataselect[[i,j,1]]<tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]||titrationdataselect[[i,j,1]]>tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]]+tablefullwlinepos[[mm,8]],"",titrationdataselect[[i,j,2]]-If[titrationdataselect[[i,j,1]]<tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]],Quiet[multifit[1,0,titrationdataselect[[i,j,1]],i]],Quiet[multifit[0,1,titrationdataselect[[i,j,1]],i]]]]},{i,Dimensions[titrationdataselect][[1]]},{j,1,Dimensions[titrationdataselect][[2]]}];allresidueplot[[mm]]=ListPlot[residueplottable,PlotRange->{{tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]],tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]]+If[plotlimit>tablefullwlinepos[[mm,8]],plotlimit,tablefullwlinepos[[mm,8]]]},Automatic},ImageSize->Medium, BaseStyle->{FontSize->15},Frame->True,FrameLabel->{{"Response (RU)",None},{"Time (S)",None}}];assoplot=Quiet[{multifit[1,0,t,1],multifit[1,0,t,2],multifit[1,0,t,3],multifit[1,0,t,4],multifit[1,0,t,5]}[[Reverse[Range[Length[CanalyteConc]]]]]];
dissplot=Quiet[{multifit[0,1,t,1],multifit[0,1,t,2],multifit[0,1,t,3],multifit[0,1,t,4],multifit[0,1,t,5]}[[Reverse[Range[Length[CanalyteConc]]]]]];
bulkline=Quiet[{{{t0,multifit[1,0,t0,1]},{t0,multifit[0,1,t0,1]}},{{t0,multifit[1,0,t0,2]},{t0,multifit[0,1,t0,2]}},{{t0,multifit[1,0,t0,3]},{t0,multifit[0,1,t0,3]}},{{t0,multifit[1,0,t0,4]},{t0,multifit[0,1,t0,4]}},{{t0,multifit[1,0,t0,5]},{t0,multifit[0,1,t0,5]}}}[[Reverse[Range[Length[CanalyteConc]]]]]];allplot[[mm]]=Show[{ListPlot[singledatatofitnoemptyplot[[All,{3,5}]],PlotStyle->Gray,PlotRange->{{tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]],tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]]+If[plotlimit>tablefullwlinepos[[mm,8]],plotlimit,tablefullwlinepos[[mm,8]]]},{ymin,ymax}},GridLines->{{{tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]],Red},{tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]],Red},{tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]]+If[plotlimit>tablefullwlinepos[[mm,8]],plotlimit,tablefullwlinepos[[mm,8]]],Red}},None},ImageSize->Medium,BaseStyle->{FontSize->15},Frame->True,FrameLabel->{{"Response (RU)",None},{"Time (S)",None}}],Plot[assoplot,{t,tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]],t0},PlotRange->{{tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]],tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]]+tablefullwlinepos[[mm,8]]},{ymin,ymax}},PlotLegends->Reverse[CanalyteConc]*10^9],Plot[dissplot,{t,t0,tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]]+tablefullwlinepos[[mm,8]]},PlotRange->{{tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]],tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]]+tablefullwlinepos[[mm,8]]},{ymin,ymax}}],
ListLinePlot[bulkline]}]]];temptime=StringJoin[ToString[Now[[1,1]]],"_",ToString[Now[[1,2]]],"_",ToString[Now[[1,3]]]," ",ToString[Now[[1,4]]],"_",ToString[Now[[1,5]]]];fullreport=Join[{{"Ligand","Analyte","Block","Well","ROI","Fitting#","Rmax 1","Rmax 1 StdErr","Rmax 2","Rmax 2 StdErr","Rmax 3","Rmax 3 StdErr","Rmax 4","Rmax 4 StdErr","Rmax 5","Rmax 5 StdErr","Rmax Global","Rmax Global StdErr","ka","ka StdErr","kd","kd StdErr","KD","KD StdErr"}},Transpose[Join[Transpose[tablefullwlinepos[[All,{5,4,2,3}]]],{ROIposreport},{Table[1,{i,Length[tablefullwlinepos]}]},Transpose[allparareport]]]];Export[StringJoin[DirectoryName[gridpath],"Titration Analysis_Carterra_Report_",temptime,".csv"],fullreport];Export[StringJoin[DirectoryName[gridpath],"Titration Analysis_Carterra_Report_",temptime,".pdf"],Style[fullreport//TableForm,FontSize->15]];(*Export[StringJoin[DirectoryName[gridpath],"Titration Analysis_Carterra_Report_",temptime,".jpg"],Style[fullreport//TableForm,FontSize->15]];*)nb=CreateDocument[Table[Column[{Grid[{{allplot[[i]],allresponseplot[[i]]},{allresidueplot[[i]],Style[allparatableprint[[i]]//TableForm,ShowStringCharacters->False,FontSize->15]}},Alignment->{{Left,Top},{Top,Right}}],TextCell[Style[StringJoin[{"Block: ",ToString[tablefullwlinepos[[i,2]]]," Well: ",ToString[tablefullwlinepos[[i,3]]]," ROI: ",ToString[ROIposreport[[i]]]," AUC: ",If[NumberQ[allauc[[i]]],ToString[DecimalForm[allauc[[i]]]],"0"]}],FontSize->20,ShowStringCharacters->False]],TextCell[ToString[tablefullwlinepos[[i,5]]],"Section"],TextCell[ToString[tablefullwlinepos[[i,4]]],"Section"]},"Center"],{i,Count[tablefull[[All,1]],"Y"]}],PrintingOptions->{"PaperSize"->{11*72,8.5*72},"PageSize"->{11*72,8.5*72}}];Export[StringJoin[DirectoryName[gridpath],"Titration Analysis_Carterra_Sensorgram_",temptime,".pdf"],nb];NotebookClose[nb];Print["Carterra Titration Analysis Done"],Print["Information provided does not match the data"]],Print["The first data column should not be numbers"]],Print["The second and third data column should be the X Y values of the first data point"]]],Print["Number of samples indicated in the info sheet does not match the data"]]]],Print["Please correct errors in the information sheet"]];
Print["This is the end of the Carterra module"],If[methodtemp=="CarterraDev",platefullsep=Tuples[{Capitalize[Alphabet[]][[Range[1,8]]],Range[1,12]}];
platefull=Table[StringJoin[platefullsep[[i,1]],ToString[platefullsep[[i,2]]]],{i,Length[platefullsep]}];
blockfull=CharacterRange["1","4"];cussortstring="Use info sheet sorting";DialogInput[{"Please indicate whether to sort differently than info sheet",PopupMenu[
Dynamic[cussortstring],{"Use info sheet sorting","Sort as duplicate plating"}],DefaultButton[DialogReturn[{}]]}];cussort=If[cussortstring=="Use info sheet sorting",1,0];tablefulltemp=Flatten[Table[blockpossep=StringSplit[StringDelete[If[NumberQ[gridfilenotitle[[i,2]]],ToString[IntegerPart[gridfilenotitle[[i,2]]]],gridfilenotitle[[i,2]]]," "],","];blockpos=Flatten[Table[If[StringFreeQ[blockpossep[[i]],"All"]==False,blockfull,If[StringFreeQ[blockpossep[[i]],"-"]==False&&StringLength[blockpossep[[i]]]>=3&&NumberQ[ToExpression[StringSplit[blockpossep[[i]],"-"][[1]]]]&&NumberQ[ToExpression[StringSplit[blockpossep[[i]],"-"][[2]]]],IntegerString[Range[ToExpression[StringSplit[blockpossep[[i]],"-"][[1]]],ToExpression[StringSplit[blockpossep[[i]],"-"][[2]]]]],If[NumberQ[ToExpression[blockpossep[[i]]]],ToString[ToExpression[blockpossep[[i]]]],blockpossep[[i]]]]],{i,Length[blockpossep]}]];platepossep=StringSplit[StringDelete[If[NumberQ[gridfilenotitle[[i,3]]],ToString[IntegerPart[gridfilenotitle[[i,3]]]],gridfilenotitle[[i,3]]]," "],","];platepos=If[StringFreeQ[ToString[gridfilenotitle[[i,3]]],"All"]==False,platefull,Flatten[Table[If[StringFreeQ[platepossep[[i]],"-"]==False&&StringLength[platepossep[[i]]]>=5&&LetterQ[StringTake[StringSplit[platepossep[[i]],"-"][[1]],1]]&&LetterQ[StringTake[StringSplit[platepossep[[i]],"-"][[2]],1]]&&NumberQ[ToExpression[StringDrop[StringSplit[platepossep[[i]],"-"][[1]],1]]]&&NumberQ[ToExpression[StringDrop[StringSplit[platepossep[[i]],"-"][[2]],1]]],inditupletemp=Tuples[{CharacterRange[ToUpperCase[StringTake[StringSplit[platepossep[[i]],"-"][[1]],1]],ToUpperCase[StringTake[StringSplit[platepossep[[i]],"-"][[2]],1]]],Range[ToExpression[StringDrop[StringSplit[platepossep[[i]],"-"][[1]],1]],ToExpression[StringDrop[StringSplit[platepossep[[i]],"-"][[2]],1]]]}];Table[StringJoin[inditupletemp[[i,1]],ToString[inditupletemp[[i,2]]]],{i,Length[inditupletemp]}],If[StringLength[platepossep[[i]]]>1&&LetterQ[StringTake[platepossep[[i]],1]]&&NumberQ[ToExpression[StringDrop[platepossep[[i]],1]]],StringJoin[ToUpperCase[StringTake[platepossep[[i]],1]],ToString[ToExpression[StringDrop[platepossep[[i]],1]]]],ToUpperCase[platepossep[[i]]]]],{i,Length[platepossep]}]]];
concgridsep=If[NumberQ[gridfilenotitle[[i,11]]],gridfilenotitle[[i,11]],StringSplit[StringDelete[gridfilenotitle[[i,11]]," "],","]];
concgrid=If[NumberQ[concgridsep],{concgridsep},Table[If[NumberQ[Internal`StringToDouble[concgridsep[[i]]]]==False,concgridsep[[i]],If[Internal`StringToDouble[concgridsep[[i]]]==0&&NumberQ[ToExpression[concgridsep[[i]]]]==False,concgridsep[[i]],If[SubsetQ[Join[{"+","-",".","E","e"},IntegerString[Range[0,9]]],Characters[concgridsep[[i]]]]==False||StringCount[concgridsep[[i]],"E",IgnoreCase->True]>1,concgridsep[[i]],Internal`StringToDouble[concgridsep[[i]]]]]],{i,Length[concgridsep]}]];
concgridinclsep=If[NumberQ[gridfilenotitle[[i,12]]],gridfilenotitle[[i,12]],StringSplit[StringDelete[gridfilenotitle[[i,12]]," "],","]];
concdridincl=If[NumberQ[concgridinclsep],{concgridinclsep},If[StringFreeQ[gridfilenotitle[[i,12]],"All"]==False,concgrid,Table[If[NumberQ[Internal`StringToDouble[concgridinclsep[[i]]]]==False,concgridinclsep[[i]],If[Internal`StringToDouble[concgridinclsep[[i]]]==0&&NumberQ[ToExpression[concgridinclsep[[i]]]]==False,concgridinclsep[[i]],If[SubsetQ[Join[{"+","-",".","E","e"},IntegerString[Range[0,9]]],Characters[concgridinclsep[[i]]]]==False||StringCount[concgridinclsep[[i]],"E",IgnoreCase->True]>1,concgridinclsep[[i]],Internal`StringToDouble[concgridinclsep[[i]]]]]],{i,Length[concgridinclsep]}]]];
tupletemp=Tuples[{{gridfilenotitle[[i,1]]},blockpos,platepos}];Table[Flatten[{tupletemp[[j]],gridfilenotitle[[i,Range[4,10]]],{concgrid},{concdridincl},gridfilenotitle[[i,Range[13,17]]]},1],{j,Length[tupletemp]}],
{i,Length[gridfilenotitle]}],1];tablefull=If[cussort==1,tablefulltemp,SortBy[tablefulltemp,If[Mod[Position[Capitalize[Alphabet[]],StringTake[#[[3]],1]],4][[1,1]]==0,4,Mod[Position[Capitalize[Alphabet[]],StringTake[#[[3]],1]],4][[1,1]]]&&ToExpression[StringDrop[#[[3]],1]]&&StringLength[#[[2]]]+Position[Capitalize[Alphabet[]],StringTake[#[[3]],1]][[1,1]]&&#[[2]]&]];
If[AllTrue[Select[Flatten[tablefull[[All,11]]],NumberQ[#]&],#>=0&]&&AllTrue[Flatten[tablefull[[All,11]]],NumberQ[#]||#=="NA"&]&&AllTrue[Flatten[tablefull[[All,12]]],NumberQ[#]||#=="NA"&]&&AllTrue[tablefull[[All,1]],MemberQ[{"Y","N"},#]&]&&AllTrue[tablefull[[All,13]],MemberQ[{"Y","N"},#]&]&&AllTrue[tablefull[[All,14]],MemberQ[{"Y","N"},#]&]&&AllTrue[tablefull[[All,16]],MemberQ[{"Y","N"},#]&]&&AllTrue[tablefull[[All,17]],MemberQ[{"Y","N"},#]&]&&AllTrue[tablefull[[All,2]],MemberQ[blockfull,#]&]&&AllTrue[tablefull[[All,3]],MemberQ[platefull,#]&]&&AllTrue[tablefull[[All,6]],NumberQ[#]&]&&AllTrue[tablefull[[All,7]],NumberQ[#]&]&&AllTrue[tablefull[[All,8]],NumberQ[#]&]&&AllTrue[tablefull[[All,9]],NumberQ[#]&]&&AllTrue[tablefull[[All,10]],NumberQ[#]&]&&AllTrue[tablefull[[All,15]],NumberQ[#]&]&&AllTrue[tablefull,SubsetQ[#[[11]],#[[12]]]&],If[Length[DeleteDuplicates[tablefull[[All,{2,3}]]]]!=Length[tablefull[[All,{2,3}]]],Print["Some spots on the chip have been included more than once"],tmpdatapath=DirectoryName[gridpath];datapath=SystemDialogInput["FileOpen",tmpdatapath,WindowTitle->"Please choose the file containing Carterra data export"];Quiet[While[FileFormat[datapath]!="CSV"&&FileFormat[datapath]!="XLS"&&FileFormat[datapath]!="XLSX",tmpdatapath=DirectoryName[datapath];datapath=SystemDialogInput["FileOpen",tmpdatapath,WindowTitle->"File format incorrect, please choose CSV file or excel worksheet"]]];Print["Please wait for CarterraDev file reading"];datafile=Quiet[Import[datapath,"Data"]];Print["CarterraDev file reading finished"];
datafileunwrap=Quiet[If[FileFormat[datapath]=="CSV",datafile,datafile[[1]]]];
datafilenotitle=Drop[datafileunwrap,1];If[TrueQ[datapath==$Canceled],Print["The user didn't provide any Carterra raw data"],If[Length[datafilenotitle]==Length[Flatten[tablefull[[All,11]]]],spotgrid=SortBy[Transpose[{Range[1,384],Flatten[ConstantArray[IntegerString[Range[1,4]],384/4]],StringJoin/@Tuples[{{"A","E","B","F","C","G","D","H"},Flatten[Transpose[ConstantArray[IntegerString[Range[12]],4]]]}]}],#[[2]]&&StringLength[#[[3]]]&&StringReverse[#[[3]]]&];spotlist=SortBy[Table[Select[spotgrid,#[[2]]==tablefull[[i,2]]&&#[[3]]==tablefull[[i,3]]&][[1]],{i, Length[tablefull]}],#[[1]]&];positionfull=Flatten[SortBy[Table[ConstantArray[Select[spotgrid,#[[2]]==tablefull[[i,2]]&&#[[3]]==tablefull[[i,3]]&][[1]],Length[tablefull[[i,11]]]],{i, Length[tablefull]}],#[[1,1]]&],1];positionlist=Table[Flatten[Position[positionfull,{spotlist[[i,1]],_,_}]],{i,Length[spotlist]}];
linepoisitionlist=Flatten[Table[Position[tablefull,{_,spotlist[[i,2]],spotlist[[i,3]],_,_,_,_,_,_,_,_,_,_,_,_,_,_}],{i,Length[tablefull]}]];
tablepositionlist=Table[0,{i,Length[tablefull]}];
Table[tablepositionlist[[linepoisitionlist[[i]]]]=positionlist[[i]],{i,Length[tablefull]}];
tablefullwlinepos=DeleteCases[Transpose[Join[Transpose[tablefull],{tablepositionlist}]],{"N",_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_}];ROImapfull=Transpose[Join[Transpose[SortBy[Tuples[{blockfull,platefull}],StringTake[#[[2]],1]&&ToExpression[StringDrop[#[[2]],1]]&]],{Join[Range[1,48],Range[1,48]+96,Range[1,48]+96*2,Range[1,48]+96*3,Range[49,96],Range[49,96]+96,Range[49,96]+96*2,Range[49,96]+96*3]}]];
ROIposreport =Flatten[Table[ROImapfull[[Position[ROImapfull[[All,{1,2}]],tablefullwlinepos[[i,{2,3}]]][[1]],3]],{i,Length[tablefullwlinepos]}]];If[Dimensions[datafilenotitle][[2]]<3,Print["No more than 3"],(*A table for checking sample name*)If[AllTrue[datafilenotitle[[All,2]],NumberQ[#]&]&&AllTrue[datafilenotitle[[All,3]],NumberQ[#]&],If[AllTrue[datafilenotitle[[All,1]],StringQ[#]&],analytecheck=Table[If[AllTrue[Table[StringSplit[datafilenotitle[[i,1]],"-"][[1]],{i,tablepositionlist[[j]]}],StringMatchQ[#,StringSplit[datafilenotitle[[tablepositionlist[[j,1]],1]],"-"][[1]]]&],"SameAna","DiffAna"],{j,Length[tablepositionlist]}];If[AllTrue[analytecheck,StringMatchQ[#,"SameAna"]&],kdfixa=1;kdfixb=-5;DialogInput[{"Please define the cutoff for off rate",Row[{InputField[Dynamic[kdfixa],FieldSize->5,BaselinePosition->Top],Panel["x10",FrameMargins->None,BaselinePosition->Top],InputField[Dynamic[kdfixb],FieldSize->5]}],DefaultButton[DialogReturn[{}]]}];
While[NumberQ[Internal`StringToDouble[StringJoin[ToString[kdfixa],"E",ToString[kdfixb]]]]==False||TrueQ[Internal`StringToDouble[StringJoin[ToString[kdfixa],"E",ToString[kdfixb]]]<=0]||TrueQ[Internal`StringToDouble[StringJoin[ToString[kdfixa],"E",ToString[kdfixb]]]>0.0001]||NumberQ[kdfixa]==False||NumberQ[kdfixb]==False,DialogInput[{"Value not accepted, please redefine",Row[{InputField[Dynamic[kdfixa],FieldSize->5,BaselinePosition->Top],Panel["x10",FrameMargins->None,BaselinePosition->Top],InputField[Dynamic[kdfixb],FieldSize->5]}],DefaultButton[DialogReturn[{}]]}]];
kdfix=Internal`StringToDouble[StringJoin[ToString[kdfixa],"E",ToString[kdfixb]]];(*define equations here*)allplot=Table[0,{i,Count[tablefull[[All,1]],"Y"]}];allparatable=Table[0,{i,Count[tablefull[[All,1]],"Y"]}];allparatableprint=Table[0,{i,Count[tablefull[[All,1]],"Y"]}];
allparareport=Table[0,{i,Count[tablefull[[All,1]],"Y"]}];allresidueplot=Table[0,{i,Count[tablefull[[All,1]],"Y"]}];allresponseplot=Table[0,{i,Count[tablefull[[All,1]],"Y"]}];allresponsetable = Table[0,{i,Count[tablefull[[All,1]],"Y"]}];allauc=Table[0,{i,Count[tablefull[[All,1]],"Y"]}];paratoinit="kd";DialogInput[{"Default to be ka; if off rate fitting is less than ideal, change to kd",PopupMenu[
Dynamic[paratoinit],{"ka","kd"}],DefaultButton[DialogReturn[{}]]}];
parakakd=If[paratoinit=="ka",{{ka,10000},kd},{ka,{kd,0.00001}}];includeassobkstring="NO";DialogInput[{"Please indicate whether to account for association bulk shift",PopupMenu[
Dynamic[includeassobkstring],{"YES","NO"}],DefaultButton[DialogReturn[{}]]}];includeassobk=If[includeassobkstring=="YES",1,0];timelimitstring="240 seconds";DialogInput[{"Please select max time allowed for each analysis",PopupMenu[
Dynamic[timelimitstring],{"60 seconds","120 seconds","240 seconds"}],DefaultButton[DialogReturn[{}]]}];timelimit=If[timelimitstring=="60 seconds",30,If[timelimitstring=="120 seconds",60,120]];plotlimitstring="300 seconds";DialogInput[{"Please select minimum plotting window for dissociation",PopupMenu[
Dynamic[plotlimitstring],{"100 seconds","300 seconds","600 seconds","900 seconds"}],DefaultButton[DialogReturn[{}]]}];plotlimit=If[plotlimitstring=="100 seconds",100,If[plotlimitstring=="300 seconds",300,If[plotlimitstring=="600 seconds",600,900]]];includepdfstring="Not Include";DialogInput[{"Please indicate whether to include long report and PDFs",PopupMenu[
Dynamic[includepdfstring],{"Include","Not Include"}],DefaultButton[DialogReturn[{}]]}];includepdf=If[includepdfstring=="Include",1,0];includepngstring="Not Export";DialogInput[{"Please indicate whether to export individual PNG images",PopupMenu[
Dynamic[includepngstring],{"Export","Not Export"}],DefaultButton[DialogReturn[{}]]}];includepng=If[includepngstring=="Export",1,0];mm=1;Print[Row[{ProgressIndicator[Dynamic[mm-1],{0,Count[tablefull[[All,1]],"Y"]}]," Finished analyzing ",Dynamic[ToString[mm-1]]," of ", ToString[Count[tablefull[[All,1]],"Y"]]," samples"}]];For[mm=1,mm<=Count[tablefull[[All,1]],"Y"],mm++,titrationdatatemp=Table[Partition[Drop[datafilenotitle[[i]],1],2],{i,tablefullwlinepos[[mm,18]]}];maxpos=Flatten[If[SubsetQ[tablefullwlinepos[[mm,11]],{"NA"}],Position[tablefullwlinepos[[mm,11]],Max[tablefullwlinepos[[mm,11]]][[1]]],Position[tablefullwlinepos[[mm,11]],Max[tablefullwlinepos[[mm,11]]]]]][[1]];
allbase=Table[If[titrationdatatemp[[i,1,1]]<tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]],Mean[Select[titrationdatatemp[[i]],#[[1]]<tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]&][[All,2]]],titrationdatatemp[[i,1,2]]],{i,Length[titrationdatatemp]}];minbase=Min[allbase];refbase=allbase[[maxpos]];If[tablefullwlinepos[[mm,16]]=="N"||tablefullwlinepos[[mm,6]]==0,titrationdataraw=titrationdatatemp, If[tablefullwlinepos[[mm,14]]=="Y"||refbase<=0,titrationdataraw=Table[Transpose[{titrationdatatemp[[i,All,1]],titrationdatatemp[[i,All,2]]-allbase[[i]]}],{i,Length[titrationdatatemp]}],titrationdataraw=Table[Transpose[{titrationdatatemp[[i,All,1]],titrationdatatemp[[i,All,2]]-minbase}],{i,Length[titrationdatatemp]}]]];
sortedinclconc=DeleteDuplicates[DeleteCases[DeleteCases[Sort[tablefullwlinepos[[mm,12]]],0.0],"NA"]];inclconcpos=Flatten[Table[Position[tablefullwlinepos[[mm,11]],sortedinclconc[[i]]][[1]],{i,Length[sortedinclconc]}]];
If[SubsetQ[tablefullwlinepos[[mm,11]],{0.0}]==False,titrationdatasorted=titrationdataraw[[inclconcpos]],zeropos=Flatten[Position[tablefullwlinepos[[mm,11]],0.0]][[1]];titrationdatasorted=Table[Transpose[{titrationdataraw[[i,All,1]],titrationdataraw[[i,All,2]]-titrationdataraw[[zeropos,All,2]]}],{i,inclconcpos}]];maxconcnum=5;If[Length[titrationdatasorted]<=maxconcnum||AllTrue[titrationdatasorted,Min[Select[#[[All,1]],NumberQ[#]&]]>tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]]-5||Max[Select[#[[All,1]],NumberQ[#]&]]<tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]]-15&],titrationdataselect=titrationdatasorted;CanalyteConc=sortedinclconc,singletitrationresponse=Table[Mean[Select[titrationdatasorted[[j]],#[[1]]<=tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]]-5&&#[[1]]>=tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]]-15&][[All,2]]],{j,1,Length[titrationdatasorted]}];singletitrationresponsediff=Join[{singletitrationresponse[[1]]},Table[singletitrationresponse[[j+1]]-singletitrationresponse[[j]],{j,1,Length[titrationdatasorted]-1}]];
singletitrationresponsewindow=Table[Total[singletitrationresponsediff[[Range[j,maxconcnum-1+j]]]],{j,1,Length[titrationdatasorted]-(maxconcnum-1)}];
maxtitrationposition=Position[singletitrationresponsewindow,Max[singletitrationresponsewindow]][[1,1]]+maxconcnum-1;titrationdataselect=titrationdatasorted[[Range[maxtitrationposition-maxconcnum+1,maxtitrationposition]]];CanalyteConc=sortedinclconc[[Range[maxtitrationposition-maxconcnum+1,maxtitrationposition]]]];singledatatofit=Flatten[Table[{If[titrationdataselect[[i,j,1]]<tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]],1,0],If[titrationdataselect[[i,j,1]]<tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]],0,1],titrationdataselect[[i,j,1]],i,titrationdataselect[[i,j,2]]},{i,Dimensions[titrationdataselect][[1]]},{j,1,Dimensions[titrationdataselect][[2]]}],1];singledatatofitnoempty =Select[Select[singledatatofit,#[[1]]>=0&],(#[[3]]>=tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,9]]&&#[[3]]<=tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]])||(#[[3]]>=tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]]+tablefullwlinepos[[mm,10]]&&#[[3]]<=tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]]+tablefullwlinepos[[mm,8]])&];
singledatatofitnoemptyplot =Select[Select[singledatatofit,#[[1]]>=0&],#[[3]]>=tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]&&#[[3]]<=tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]]+If[plotlimit>tablefullwlinepos[[mm,8]],plotlimit,tablefullwlinepos[[mm,8]]]&];If[Length[singledatatofitnoempty]<1,parametertable=If[tablefullwlinepos[[mm,17]]=="Y",Transpose[{{"Parameter","Rmax Global","ka","kd"},{"Value","NA","NA","NA"},{"StdErr","NA","NA","NA"}}],Transpose[{{"Parameter","Rmax 1","Rmax 2","Rmax 3","Rmax 4","Rmax 5","ka","kd"},{"Value","NA","NA","NA","NA","NA","NA","NA"},{"StdErr","NA","NA","NA","NA","NA","NA","NA"}}]];allparatable[[mm]]=parametertable;allparatableprint[[mm]]=parametertable;allparareport[[mm]]=Table["NA",{i,18}];allresidueplot[[mm]]=ListPlot[{0,0},ImageSize->Medium, BaseStyle->{FontSize->15},Frame->True,FrameLabel->{{"Response (RU)",None},{"Time (S)",None}}];allresponseplot[[mm]]=ListPlot[{0,0},ImageSize->Medium, BaseStyle->{FontSize->15},Frame->True,FrameLabel->{{"Response (RU)",None},{"Concentration (nM)",None}}];allauc[[mm]]=0;allplot[[mm]]=ListPlot[singledatatofitnoemptyplot[[All,{3,5}]],GridLines->{{{tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]],Red},{tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]],Red},{tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]]+tablefullwlinepos[[mm,8]],Red}},None},ImageSize->Medium,  BaseStyle->{FontSize->15},Frame->True,FrameLabel->{{"Response (RU)",None},{"Time (S)",None}}],ymax=Max[singledatatofitnoemptyplot[[All,5]]]*1.1;ymin=If[Min[singledatatofitnoemptyplot[[All,5]]]>=0,0,Min[singledatatofitnoemptyplot[[All,5]]]*1.1];t0=tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]];
tstartall=tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]];If[tablefullwlinepos[[mm,17]]=="Y",nonsensefitglobal=Quiet[NonlinearModelFit[{{1,0,1,1,1}},{asc*RTRegenGlobal[t,ii]+dis*RTdisRegenGlobal[t,ii],Rmaxglobal<400},{Rmaxglobal,{ka,10000},kd},{asc,dis,t,ii}, MaxIterations->20000]];
nonsensefitbkglobal=Quiet[NonlinearModelFit[{{1,0,1,1,1}},{asc*RTRegenbkGlobal[t,ii]+dis*RTdisRegenbkGlobal[t,ii],Rmaxglobal<400},Join[{Rmaxglobal},Transpose[{shiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{{ka,10000},kd}],{asc,dis,t,ii}, MaxIterations->20000]];nonsensefitbkglobal2=Quiet[NonlinearModelFit[{{1,0,1,1,1}},{asc*RTRegenbkGlobal2[t,ii]+dis*RTdisRegenbkGlobal2[t,ii],Rmaxglobal<400},Join[{Rmaxglobal},Transpose[{bshiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{{ka,10000},kd}],{asc,dis,t,ii}, MaxIterations->20000]];If[tablefullwlinepos[[mm,13]]=="Y",If[includeassobk==1,multifittemp= If[tablefullwlinepos[[mm,14]]=="Y"||refbase<=0,Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenbkGlobal2[t,ii]+dis*RTdisRegenbkGlobal2[t,ii]},Join[{Rmaxglobal},Transpose[{bshiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefitbkglobal2]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenbkGlobal2[t,ii]+dis*RTdisNonregenbkGlobal2[t,ii]},Join[{Rmaxglobal},tstartlist[[Range[Length[CanalyteConc]]]],Transpose[{bshiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefitbkglobal2]]];
If[Quiet[Reverse[multifittemp["BestFitParameters"]][[1,2]]]>=kdfix,multifit=multifittemp;useless=0,multifit=If[tablefullwlinepos[[mm,14]]=="Y"||refbase<=0,Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenkdbkGlobal2[t,ii]+dis*RTdisRegenkdbkGlobal2[t,ii]},Join[{Rmaxglobal},Transpose[{bshiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefitbkglobal2]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenkdbkGlobal2[t,ii]+dis*RTdisNonregenkdbkGlobal2[t,ii]},Join[{Rmaxglobal},tstartlist[[Range[Length[CanalyteConc]]]],Transpose[{bshiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefitbkglobal2]]]],multifittemp= If[tablefullwlinepos[[mm,14]]=="Y"||refbase<=0,Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenbkGlobal[t,ii]+dis*RTdisRegenbkGlobal[t,ii]},Join[{Rmaxglobal},Transpose[{shiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefitbkglobal]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenbkGlobal[t,ii]+dis*RTdisNonregenbkGlobal[t,ii]},Join[{Rmaxglobal},tstartlist[[Range[Length[CanalyteConc]]]],Transpose[{shiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefitbkglobal]]];
If[Quiet[Reverse[multifittemp["BestFitParameters"]][[1,2]]]>=kdfix,multifit=multifittemp;useless=0,multifit=If[tablefullwlinepos[[mm,14]]=="Y"||refbase<=0,Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenkdbkGlobal[t,ii]+dis*RTdisRegenkdbkGlobal[t,ii]},Join[{Rmaxglobal},Transpose[{shiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefitbkglobal]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenkdbkGlobal[t,ii]+dis*RTdisNonregenkdbkGlobal[t,ii]},Join[{Rmaxglobal},tstartlist[[Range[Length[CanalyteConc]]]],Transpose[{shiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefitbkglobal]]]]],multifittemp= If[tablefullwlinepos[[mm,14]]=="Y"||refbase<=0,Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenGlobal[t,ii]+dis*RTdisRegenGlobal[t,ii],Rmaxglobal<400},Join[{Rmaxglobal},parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefitglobal]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenGlobal[t,ii]+dis*RTdisNonregenGlobal[t,ii]},Join[{Rmaxglobal},tstartlist[[Range[Length[CanalyteConc]]]],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefitglobal]]];
If[Quiet[Reverse[multifittemp["BestFitParameters"]][[1,2]]]>=kdfix,multifit=multifittemp;useless=0,multifit=If[tablefullwlinepos[[mm,14]]=="Y"||refbase<=0,Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenkdGlobal[t,ii]+dis*RTdisRegenkdGlobal[t,ii]},{Rmaxglobal,ka},{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefitglobal]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenkdGlobal[t,ii]+dis*RTdisNonregenkdGlobal[t,ii]},Join[{Rmaxglobal},tstartlist[[Range[Length[CanalyteConc]]]],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefitglobal]]]]];parametertable=Transpose[{{"Parameter","Rmax Global","ka","kd","KD"},{"Value","NA","NA","NA","NA"},{"StdErr","NA","NA","NA","NA"}}];If[MatchQ[Quiet[multifit["ParameterTable"]],Missing[]]==False,tempparatable=Quiet[multifit["ParameterTable"]][[1,1]];parametertable[[2,{2,3}]]=tempparatable[[2,{2,3}]];If[MatchQ[tempparatable[[-1,1]],kd],parametertable[[{-3,-2},{2,3}]]=tempparatable[[{-2,-1},{2,3}]];parametertable[[-1,2]]=tempparatable[[-1,2]]/tempparatable[[-2,2]];parametertable[[-1,3]]=tempparatable[[-1,2]]/tempparatable[[-2,2]]*Sqrt[(tempparatable[[-1,3]]/tempparatable[[-1,2]])^2+(tempparatable[[-2,3]]/tempparatable[[-2,2]])^2],parametertable[[-3,{2,3}]]=tempparatable[[-1,{2,3}]];parametertable[[-2,2]]=kdfix;parametertable[[-1,2]]=kdfix/tempparatable[[-1,2]]]];allparatable[[mm]]=parametertable;allparatableprint[[mm]]=Join[{parametertable[[1]]},Table[If[i<3,{parametertable[[i,1]],NumberForm[parametertable[[i,2]],{\[Infinity],2}],NumberForm[parametertable[[i,3]],{\[Infinity],2}]},{parametertable[[i,1]],ScientificForm[parametertable[[i,2]],4],ScientificForm[parametertable[[i,3]],4]}],{i,2,Length[parametertable]}]];allparareport[[mm]]=Join[{"NA","NA","NA","NA","NA","NA","NA","NA","NA","NA"},Flatten[Drop[parametertable[[All,{2,3}]],1]]],
nonsensefit=Quiet[NonlinearModelFit[{{1,0,1,1,1}},Join[{asc*RTRegen[t,ii]+dis*RTdisRegen[t,ii]},Table[ToExpression[StringJoin[ToString[Rmaxlist[[i]]],"<400"]],{i,Length[CanalyteConc]}]],Join[Rmaxlist[[Range[Length[CanalyteConc]]]],{{ka,10000},kd}],{asc,dis,t,ii}, MaxIterations->20000]];
nonsensefitbk=Quiet[NonlinearModelFit[{{1,0,1,1,1}},Join[{asc*RTRegenbk[t,ii]+dis*RTdisRegenbk[t,ii]},Table[ToExpression[StringJoin[ToString[Rmaxlist[[i]]],"<400"]],{i,Length[CanalyteConc]}]],Join[Rmaxlist[[Range[Length[CanalyteConc]]]],Transpose[{shiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{{ka,10000},kd}],{asc,dis,t,ii}, MaxIterations->20000]];nonsensefitbk2=Quiet[NonlinearModelFit[{{1,0,1,1,1}},Join[{asc*RTRegenbk2[t,ii]+dis*RTdisRegenbk2[t,ii]},Table[ToExpression[StringJoin[ToString[Rmaxlist[[i]]],"<400"]],{i,Length[CanalyteConc]}]],Join[Rmaxlist[[Range[Length[CanalyteConc]]]],Transpose[{bshiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{{ka,10000},kd}],{asc,dis,t,ii}, MaxIterations->20000]];If[tablefullwlinepos[[mm,13]]=="Y",If[includeassobk==1,multifittemp= If[tablefullwlinepos[[mm,14]]=="Y"||refbase<=0,Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenbk2[t,ii]+dis*RTdisRegenbk2[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],Transpose[{bshiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefitbk2]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenbk2[t,ii]+dis*RTdisNonregenbk2[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],tstartlist[[Range[Length[CanalyteConc]]]],Transpose[{bshiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefitbk2]]];
If[Quiet[Reverse[multifittemp["BestFitParameters"]][[1,2]]]>=kdfix,multifit=multifittemp;useless=0,multifit=If[tablefullwlinepos[[mm,14]]=="Y"||refbase<=0,Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenkdbk2[t,ii]+dis*RTdisRegenkdbk2[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],Transpose[{bshiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefitbk2]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenkdbk2[t,ii]+dis*RTdisNonregenkdbk2[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],tstartlist[[Range[Length[CanalyteConc]]]],Transpose[{bshiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefitbk2]]]],multifittemp= If[tablefullwlinepos[[mm,14]]=="Y"||refbase<=0,Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenbk[t,ii]+dis*RTdisRegenbk[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],Transpose[{shiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefitbk]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenbk[t,ii]+dis*RTdisNonregenbk[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],tstartlist[[Range[Length[CanalyteConc]]]],Transpose[{shiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefitbk]]];
If[Quiet[Reverse[multifittemp["BestFitParameters"]][[1,2]]]>=kdfix,multifit=multifittemp;useless=0,multifit=If[tablefullwlinepos[[mm,14]]=="Y"||refbase<=0,Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenkdbk[t,ii]+dis*RTdisRegenkdbk[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],Transpose[{shiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefitbk]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenkdbk[t,ii]+dis*RTdisNonregenkdbk[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],tstartlist[[Range[Length[CanalyteConc]]]],Transpose[{shiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefitbk]]]]],multifittemp= If[tablefullwlinepos[[mm,14]]=="Y"||refbase<=0,Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,Join[{asc*RTRegen[t,ii]+dis*RTdisRegen[t,ii]},Table[ToExpression[StringJoin[ToString[Rmaxlist[[i]]],"<400"]],{i,Length[CanalyteConc]}]],Join[Rmaxlist[[Range[Length[CanalyteConc]]]],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefit]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregen[t,ii]+dis*RTdisNonregen[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],tstartlist[[Range[Length[CanalyteConc]]]],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefit]]];
If[Quiet[Reverse[multifittemp["BestFitParameters"]][[1,2]]]>=kdfix,multifit=multifittemp;useless=0,multifit=If[tablefullwlinepos[[mm,14]]=="Y"||refbase<=0,Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenkd[t,ii]+dis*RTdisRegenkd[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefit]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenkd[t,ii]+dis*RTdisNonregenkd[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],tstartlist[[Range[Length[CanalyteConc]]]],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefit]]]]];parametertable=Transpose[{{"Parameter","Rmax 1","Rmax 2","Rmax 3","Rmax 4","Rmax 5","ka","kd","KD"},{"Value","NA","NA","NA","NA","NA","NA","NA","NA"},{"StdErr","NA","NA","NA","NA","NA","NA","NA","NA"}}];If[MatchQ[Quiet[multifit["ParameterTable"]],Missing[]]==False,tempparatable=Quiet[multifit["ParameterTable"]][[1,1]];parametertable[[1+Range[Length[CanalyteConc]],{2,3}]]=tempparatable[[1+Range[Length[CanalyteConc]],{2,3}]];If[MatchQ[tempparatable[[-1,1]],kd],parametertable[[{-3,-2},{2,3}]]=tempparatable[[{-2,-1},{2,3}]];parametertable[[-1,2]]=tempparatable[[-1,2]]/tempparatable[[-2,2]];parametertable[[-1,3]]=tempparatable[[-1,2]]/tempparatable[[-2,2]]*Sqrt[(tempparatable[[-1,3]]/tempparatable[[-1,2]])^2+(tempparatable[[-2,3]]/tempparatable[[-2,2]])^2],parametertable[[-3,{2,3}]]=tempparatable[[-1,{2,3}]];parametertable[[-2,2]]=kdfix;parametertable[[-1,2]]=kdfix/tempparatable[[-1,2]]]];allparatable[[mm]]=parametertable;allparatableprint[[mm]]=Join[{parametertable[[1]]},Table[If[i<7,{parametertable[[i,1]],NumberForm[parametertable[[i,2]],{\[Infinity],2}],NumberForm[parametertable[[i,3]],{\[Infinity],2}]},{parametertable[[i,1]],ScientificForm[parametertable[[i,2]],4],ScientificForm[parametertable[[i,3]],4]}],{i,2,Length[parametertable]}]];allparareport[[mm]]=Join[Flatten[Drop[parametertable[[All,{2,3}]],1]][[Range[1,10]]],{"NA","NA"},Flatten[Drop[parametertable[[All,{2,3}]],1]][[Range[-6,-1]]]]];aucreponselist=SortBy[Select[DeleteDuplicates[Join[Transpose[{tablefullwlinepos[[mm,11]]*10^9,Table[Mean[Select[titrationdataraw[[j]],#[[1]]<=tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]]-5&&#[[1]]>=tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]]-15&][[All,2]]],{j,1,Length[titrationdataraw]}]}],{{0,0}}],#1[[1]]==#2[[1]]&],NumberQ[#[[1]]]&],#1&];aucreponselistselect=Select[aucreponselist,SubsetQ[CanalyteConc*10^9,{#[[1]]}]&];responsetableind = Partition[{"NA","NA","NA","NA","NA","NA","NA","NA","NA","NA"},2];Table[responsetableind[[i]]=aucreponselistselect[[i]],{i,Length[aucreponselistselect]}];allresponsetable[[mm]]=responsetableind;allauc[[mm]]=Integrate[Interpolation[aucreponselist,InterpolationOrder->1][x],{x,0,Max[aucreponselist[[All,1]]]}];
allresponseplot[[mm]]=Show[ListPlot[Transpose[{Log[10,aucreponselist[[All,1]]],aucreponselist[[All,2]]}], ImageSize->Medium,BaseStyle->{FontSize->15},Frame->True,PlotStyle->PointSize[0.02],FrameLabel->{{"Response (RU)",None},{"log(Concentration (nM))",None}},PlotRange->All],ListPlot[Select[Transpose[{Log[10,aucreponselist[[All,1]]],aucreponselist[[All,2]]}],SubsetQ[Log[10,CanalyteConc*10^9],{#[[1]]}]&], PlotStyle->Directive[Red,PointSize[0.02]]],ListPlot[Transpose[{Log[10,aucreponselist[[All,1]]],aucreponselist[[All,2]]}],PlotRange->All,Joined->True,InterpolationOrder->1]];residueplottable=Table[{titrationdataselect[[i,j,1]],If[NumberQ[titrationdataselect[[i,j,1]]]==False||titrationdataselect[[i,j,1]]<tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]||titrationdataselect[[i,j,1]]>tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]]+tablefullwlinepos[[mm,8]],"",titrationdataselect[[i,j,2]]-If[titrationdataselect[[i,j,1]]<tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]],Quiet[multifit[1,0,titrationdataselect[[i,j,1]],i]],Quiet[multifit[0,1,titrationdataselect[[i,j,1]],i]]]]},{i,Dimensions[titrationdataselect][[1]]},{j,1,Dimensions[titrationdataselect][[2]]}];allresidueplot[[mm]]=ListPlot[residueplottable,PlotRange->{{tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]],tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]]+If[plotlimit>tablefullwlinepos[[mm,8]],plotlimit,tablefullwlinepos[[mm,8]]]},Automatic},ImageSize->Medium, BaseStyle->{FontSize->15},Frame->True,FrameLabel->{{"Response (RU)",None},{"Time (S)",None}}];assoplot=Quiet[{multifit[1,0,t,1],multifit[1,0,t,2],multifit[1,0,t,3],multifit[1,0,t,4],multifit[1,0,t,5]}[[Reverse[Range[Length[CanalyteConc]]]]]];
dissplot=Quiet[{multifit[0,1,t,1],multifit[0,1,t,2],multifit[0,1,t,3],multifit[0,1,t,4],multifit[0,1,t,5]}[[Reverse[Range[Length[CanalyteConc]]]]]];
bulkline=Quiet[{{{t0,multifit[1,0,t0,1]},{t0,multifit[0,1,t0,1]}},{{t0,multifit[1,0,t0,2]},{t0,multifit[0,1,t0,2]}},{{t0,multifit[1,0,t0,3]},{t0,multifit[0,1,t0,3]}},{{t0,multifit[1,0,t0,4]},{t0,multifit[0,1,t0,4]}},{{t0,multifit[1,0,t0,5]},{t0,multifit[0,1,t0,5]}}}[[Reverse[Range[Length[CanalyteConc]]]]]];allplot[[mm]]=Show[{ListPlot[singledatatofitnoemptyplot[[All,{3,5}]],PlotStyle->Gray,PlotRange->{{tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]],tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]]+If[plotlimit>tablefullwlinepos[[mm,8]],plotlimit,tablefullwlinepos[[mm,8]]]},{ymin,ymax}},GridLines->{{{tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]],Red},{tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]],Red},{tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]]+If[plotlimit>tablefullwlinepos[[mm,8]],plotlimit,tablefullwlinepos[[mm,8]]],Red}},None},ImageSize->Medium,BaseStyle->{FontSize->15},Frame->True,FrameLabel->{{"Response (RU)",None},{"Time (S)",None}}],Plot[assoplot,{t,tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]],t0},PlotRange->{{tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]],tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]]+tablefullwlinepos[[mm,8]]},{ymin,ymax}},PlotLegends->Reverse[CanalyteConc]*10^9],Plot[dissplot,{t,t0,tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]]+tablefullwlinepos[[mm,8]]},PlotRange->{{tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]],tablefullwlinepos[[mm,6]]+tablefullwlinepos[[mm,15]]+tablefullwlinepos[[mm,7]]+tablefullwlinepos[[mm,8]]},{ymin,ymax}}],
ListLinePlot[bulkline]}]]];
temptime=StringJoin[ToString[Now[[1,1]]],"_",ToString[Now[[1,2]]],"_",ToString[Now[[1,3]]]," ",ToString[Now[[1,4]]],"_",ToString[Now[[1,5]]]];fullreport=Join[{{"Ligand","Analyte","Block","Well","ROI","Fitting#","Rmax 1","Rmax 1 StdErr","Rmax 2","Rmax 2 StdErr","Rmax 3","Rmax 3 StdErr","Rmax 4","Rmax 4 StdErr","Rmax 5","Rmax 5 StdErr","Rmax Global","Rmax Global StdErr","ka","ka StdErr","kd","kd StdErr","KD","KD StdErr"}},Transpose[Join[Transpose[tablefullwlinepos[[All,{5,4,2,3}]]],{ROIposreport},{Table[1,{i,Length[tablefullwlinepos]}]},Transpose[allparareport]]]];fullreportlong=Join[{{"Version","ligand","analyte","block","well","roi","analyteConcentration","response","rMax","rMaxError","kOn","kOnError","kOff","kOffError","kD","kDError"}},DeleteCases[DeleteCases[Flatten[Table[Partition[Flatten[Tuples[{{"0.4.0"},{tablefullwlinepos[[i,{5,4,2,3}]]},{ROIposreport[[i]]},Partition[Join[Flatten[Transpose[{allresponsetable[[i]],Partition[Drop[allparareport[[i]],-8],2]}]],Flatten[Tuples[{allresponsetable[[i]],{allparareport[[i,{11,12}]]}}]]],4],{allparareport[[i,Range[-6,-1]]]}}]],16],{i,1,Length[allparareport]}],1],{_,_,_,_,_,_,_,_,"NA","NA",_,_,_,_,_,_}],{_,_,_,_,_,_,"NA","NA",_,_,_,_,_,_,_,_}]];Export[StringJoin[DirectoryName[gridpath],"Titration Analysis_Carterra_Report_Short_",temptime,".csv"],fullreport];If[includepdf==1,Export[StringJoin[DirectoryName[gridpath],"Titration Analysis_Carterra_Report_Short_",temptime,".pdf"],Style[fullreport//TableForm,FontSize->15]];Export[StringJoin[DirectoryName[gridpath],"Titration Analysis_Carterra_Report_Long_",temptime,".csv"],fullreportlong];Export[StringJoin[DirectoryName[gridpath],"Titration Analysis_Carterra_Report_Long_",temptime,".pdf"],Style[fullreportlong//TableForm,FontSize->15]]];nb=CreateDocument[Table[Column[{Grid[{{allplot[[i]],allresponseplot[[i]]},{allresidueplot[[i]],Style[allparatableprint[[i]]//TableForm,ShowStringCharacters->False,FontSize->15]}},Alignment->{{Left,Top},{Top,Right}}],TextCell[Style[StringJoin[{"Block: ",ToString[tablefullwlinepos[[i,2]]]," Well: ",ToString[tablefullwlinepos[[i,3]]]," ROI: ",ToString[ROIposreport[[i]]]," AUC: ",If[NumberQ[allauc[[i]]],ToString[DecimalForm[allauc[[i]]]],"0"]}],FontSize->20,ShowStringCharacters->False]],TextCell[ToString[tablefullwlinepos[[i,5]]],"Section"],TextCell[ToString[tablefullwlinepos[[i,4]]],"Section"]},"Center"],{i,Count[tablefull[[All,1]],"Y"]}],PrintingOptions->{"PaperSize"->{11*72,8.5*72},"PageSize"->{11*72,8.5*72}}];Export[StringJoin[DirectoryName[gridpath],"Titration Analysis_Carterra_Sensorgram_",temptime,".pdf"],nb];NotebookClose[nb];If[includepng==1,CreateDirectory[StringJoin[DirectoryName[gridpath],"PNG_",temptime]];kk=1;
Print[Row[{ProgressIndicator[Dynamic[kk-1],{0,Count[tablefull[[All,1]],"Y"]}]," Finished exporting PNG ",Dynamic[ToString[kk-1]]," of ", ToString[Count[tablefull[[All,1]],"Y"]]," samples"}]];For[kk=1,kk<=Count[tablefull[[All,1]],"Y"],kk++,Export[StringJoin[DirectoryName[gridpath],"PNG_",temptime,"\\",ToString[kk],"_",StringDelete[tablefullwlinepos[[kk,5]],"/"],"_",
StringDelete[tablefullwlinepos[[kk,4]],"/"],".png"],allplot[[kk]],ImageResolution->200]]];Print["Carterra Titration Analysis Done"],Print["Information provided does not match the data"]],Print["The first data column should not be numbers"]],Print["The second and third data column should be the X Y values of the first data point"]]],Print["Number of samples indicated in the info sheet does not match the data"]]]],Print["Please correct errors in the information sheet"]];
Print["This is the end of the CarterraDev module"],If[methodtemp=="T200",chipfull=Table[ToString[i],{i,100}];channelfull=CharacterRange["1","4"];tablefull=SortBy[Flatten[Table[chippossep=StringSplit[StringDelete[If[NumberQ[gridfilenotitle[[i,2]]],ToString[IntegerPart[gridfilenotitle[[i,2]]]],gridfilenotitle[[i,2]]]," "],","];chippos=Flatten[Table[If[StringFreeQ[chippossep[[i]],"-"]==False&&StringLength[chippossep[[i]]]>=3&&NumberQ[ToExpression[StringSplit[chippossep[[i]],"-"][[1]]]]&&NumberQ[ToExpression[StringSplit[chippossep[[i]],"-"][[2]]]],IntegerString[Range[ToExpression[StringSplit[chippossep[[i]],"-"][[1]]],ToExpression[StringSplit[chippossep[[i]],"-"][[2]]]]],If[NumberQ[ToExpression[chippossep[[i]]]],ToString[ToExpression[chippossep[[i]]]],chippossep[[i]]]],{i,Length[chippossep]}]];channelpossep=StringSplit[StringDelete[If[NumberQ[gridfilenotitle[[i,3]]],ToString[IntegerPart[gridfilenotitle[[i,3]]]],gridfilenotitle[[i,3]]]," "],","];channelpos=If[StringFreeQ[ToString[gridfilenotitle[[i,3]]],"All"]==False,channelfull,Flatten[Table[If[StringFreeQ[channelpossep[[i]],"-"]==False&&StringLength[channelpossep[[i]]]>=3&&NumberQ[ToExpression[StringSplit[channelpossep[[i]],"-"][[1]]]]&&NumberQ[ToExpression[StringSplit[channelpossep[[i]],"-"][[2]]]],IntegerString[Range[ToExpression[StringSplit[channelpossep[[i]],"-"][[1]]],ToExpression[StringSplit[channelpossep[[i]],"-"][[2]]]]],If[NumberQ[ToExpression[channelpossep[[i]]]],ToString[ToExpression[channelpossep[[i]]]],channelpossep[[i]]]],{i,Length[channelpossep]}]]];
concgridsep=If[NumberQ[gridfilenotitle[[i,11]]],gridfilenotitle[[i,11]],StringSplit[StringDelete[gridfilenotitle[[i,11]]," "],","]];
concgrid=If[NumberQ[concgridsep],{concgridsep},Table[If[NumberQ[Internal`StringToDouble[concgridsep[[i]]]]==False,concgridsep[[i]],If[Internal`StringToDouble[concgridsep[[i]]]==0&&NumberQ[ToExpression[concgridsep[[i]]]]==False,concgridsep[[i]],If[SubsetQ[Join[{"+","-",".","E","e"},IntegerString[Range[0,9]]],Characters[concgridsep[[i]]]]==False||StringCount[concgridsep[[i]],"E",IgnoreCase->True]>1,concgridsep[[i]],Internal`StringToDouble[concgridsep[[i]]]]]],{i,Length[concgridsep]}]];
concgridinclsep=If[NumberQ[gridfilenotitle[[i,12]]],gridfilenotitle[[i,12]],StringSplit[StringDelete[gridfilenotitle[[i,12]]," "],","]];
concdridincl=If[NumberQ[concgridinclsep],{concgridinclsep},If[StringFreeQ[gridfilenotitle[[i,12]],"All"]==False,concgrid,Table[If[NumberQ[Internal`StringToDouble[concgridinclsep[[i]]]]==False,concgridinclsep[[i]],If[Internal`StringToDouble[concgridinclsep[[i]]]==0&&NumberQ[ToExpression[concgridinclsep[[i]]]]==False,concgridinclsep[[i]],If[SubsetQ[Join[{"+","-",".","E","e"},IntegerString[Range[0,9]]],Characters[concgridinclsep[[i]]]]==False||StringCount[concgridinclsep[[i]],"E",IgnoreCase->True]>1,concgridinclsep[[i]],Internal`StringToDouble[concgridinclsep[[i]]]]]],{i,Length[concgridinclsep]}]]];
tupletemp=Tuples[{{gridfilenotitle[[i,1]]},chippos,channelpos}];Table[Flatten[{tupletemp[[j]],gridfilenotitle[[i,Range[4,10]]],{concgrid},{concdridincl},gridfilenotitle[[i,Range[13,17]]]},1],{j,Length[tupletemp]}],
{i,Length[gridfilenotitle]}],1],StringLength[#[[2]]]&&#[[2]]&&StringLength[#[[3]]]&&StringReverse[#[[3]]]&];
If[AllTrue[Select[Flatten[tablefull[[All,11]]],NumberQ[#]&],#>=0&]&&AllTrue[Flatten[tablefull[[All,11]]],NumberQ[#]||#=="NA"&]&&AllTrue[Flatten[tablefull[[All,12]]],NumberQ[#]||#=="NA"&]&&AllTrue[tablefull[[All,1]],MemberQ[{"Y","N"},#]&]&&AllTrue[tablefull[[All,13]],MemberQ[{"Y","N"},#]&]&&AllTrue[tablefull[[All,14]],MemberQ[{"Y","N"},#]&]&&AllTrue[tablefull[[All,16]],MemberQ[{"Y","N"},#]&]&&AllTrue[tablefull[[All,17]],MemberQ[{"Y","N"},#]&]&&AllTrue[tablefull[[All,2]],MemberQ[chipfull,#]&]&&AllTrue[tablefull[[All,3]],MemberQ[channelfull,#]&]&&AllTrue[tablefull[[All,6]],NumberQ[#]&]&&AllTrue[tablefull[[All,7]],NumberQ[#]&]&&AllTrue[tablefull[[All,8]],NumberQ[#]&]&&AllTrue[tablefull[[All,9]],NumberQ[#]&]&&AllTrue[tablefull[[All,10]],NumberQ[#]&]&&AllTrue[tablefull[[All,15]],NumberQ[#]&]&&AllTrue[tablefull,SubsetQ[#[[11]],#[[12]]]&],tmpdatapath=DirectoryName[gridpath];prefix="Prefix here (no quotation marks)";DialogInput[{"Please write down the prefix for all the data files",InputField[Dynamic[prefix]],DefaultButton[DialogReturn[{}]]}];If[AllTrue[tablefull[[All,{2,3}]],FileExistsQ[StringJoin[tmpdatapath,ToString[prefix]," Chip ",#[[1]]," Channel ",#[[2]],".txt"]]&],tablefullincl=DeleteCases[tablefull,{"N",_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_}];filenamenodup=DeleteDuplicates[tablefullincl[[All,{2,3}]]];
repeatcount=Flatten[Table[Table[i,{i,Count[tablefullincl[[All,{2,3}]],filenamenodup[[j]]]}],{j,Length[filenamenodup]}]];
filepos=Flatten[Table[Table[j,{i,Count[tablefullincl[[All,{2,3}]],filenamenodup[[j]]]}],{j,Length[filenamenodup]}]];
tablefullinclwinfo=Transpose[Join[Transpose[tablefullincl],{repeatcount},{filepos}]];datapath=Table[StringJoin[tmpdatapath,ToString[prefix]," Chip ",filenamenodup[[i,1]]," Channel ",filenamenodup[[i,2]],".txt"],{i,Length[filenamenodup]}];datafile=Table[0,{i,Length[filenamenodup]}];Print["Please wait for T200 data reading"];Table[datafile[[i]]=Import[datapath[[i]],"Data"],{i,Length[filenamenodup]}];
Print["T200 data reading complete"];dimentioncheck=Table[If[AllTrue[Select[tablefullinclwinfo,#[[19]]==i&],Length[#[[11]]]==Dimensions[datafile[[i]]][[2]]/2&],"SameDim","DiffDim"],{i,Length[filenamenodup]}];If[AllTrue[dimentioncheck,#=="SameDim"&],hertzstring="10Hz";DialogInput[{"Please select data collection speed used in assay",PopupMenu[
Dynamic[hertzstring],{"1Hz","10Hz"}],DefaultButton[DialogReturn[{}]]}];hertzrate=If[hertzstring=="10Hz",10,1];kdfixa=1;kdfixb=-5;DialogInput[{"Please define cutoff value for off rate",Row[{InputField[Dynamic[kdfixa],FieldSize->5,BaselinePosition->Top],Panel["x10",FrameMargins->None,BaselinePosition->Top],InputField[Dynamic[kdfixb],FieldSize->5]}],DefaultButton[DialogReturn[{}]]}];
While[NumberQ[Internal`StringToDouble[StringJoin[ToString[kdfixa],"E",ToString[kdfixb]]]]==False||TrueQ[Internal`StringToDouble[StringJoin[ToString[kdfixa],"E",ToString[kdfixb]]]<=0]||TrueQ[Internal`StringToDouble[StringJoin[ToString[kdfixa],"E",ToString[kdfixb]]]>0.0001]||NumberQ[kdfixa]==False||NumberQ[kdfixb]==False,DialogInput[{"Value not accepted, please redefine",Row[{InputField[Dynamic[kdfixa],FieldSize->5,BaselinePosition->Top],Panel["x10",FrameMargins->None,BaselinePosition->Top],InputField[Dynamic[kdfixb],FieldSize->5]}],DefaultButton[DialogReturn[{}]]}]];
kdfix=Internal`StringToDouble[StringJoin[ToString[kdfixa],"E",ToString[kdfixb]]];allplot=Table[0,{i,Length[tablefullincl]}];allparatable=Table[0,{i,Length[tablefullincl]}];allparatableprint=Table[0,{i,Length[tablefullincl]}];
allparareport=Table[0,{i,Length[tablefullincl]}];allresidueplot=Table[0,{i,Length[tablefullincl]}];allresponseplot=Table[0,{i,Length[tablefullincl]}];allresponsetable=Table[0,{i,Length[tablefullincl]}];allauc=Table[0,{i,Length[tablefullincl]}];paratoinit="ka";DialogInput[{"Default to be ka; if off rate fitting is less than ideal, change to kd",PopupMenu[
Dynamic[paratoinit],{"ka","kd"}],DefaultButton[DialogReturn[{}]]}];
parakakd=If[paratoinit=="ka",{{ka,10000},kd},{ka,{kd,0.00001}}];includeassobkstring="NO";DialogInput[{"Please indicate whether to account for association bulk shift",PopupMenu[
Dynamic[includeassobkstring],{"YES","NO"}],DefaultButton[DialogReturn[{}]]}];includeassobk=If[includeassobkstring=="YES",1,0];timelimitstring="120 seconds";DialogInput[{"Please select max time allowed for each analysis",PopupMenu[
Dynamic[timelimitstring],{"60 seconds","120 seconds","240 seconds"}],DefaultButton[DialogReturn[{}]]}];timelimit=If[timelimitstring=="60 seconds",30,If[timelimitstring=="120 seconds",60,120]];plotlimitstring="300 seconds";DialogInput[{"Please select minimum plotting window for dissociation",PopupMenu[
Dynamic[plotlimitstring],{"100 seconds","300 seconds","600 seconds","900 seconds"}],DefaultButton[DialogReturn[{}]]}];plotlimit=If[plotlimitstring=="100 seconds",100,If[plotlimitstring=="300 seconds",300,If[plotlimitstring=="600 seconds",600,900]]];mm=1;Print[Row[{ProgressIndicator[Dynamic[mm-1],{0,Length[tablefullincl]}]," Finished analyzing ",Dynamic[ToString[mm-1]]," of ", ToString[Length[tablefullincl]]," samples"}]];For[mm=1,mm<=Length[tablefullincl],mm++,titrationdatatemp2=datafile[[tablefullinclwinfo[[mm,19]]]];splittitle=Table[{ToExpression[StringSplit[titrationdatatemp2[[1,i]],{"=","_"," "}][[2]]],StringSplit[titrationdatatemp2[[1,i]],{"=","_"," "}][[-1]]},{i,Length[titrationdatatemp2[[1]]]}];titrationdatatrans=Drop[Transpose[SortBy[Transpose[Join[Transpose[splittitle],titrationdatatemp2[[Range[2,Length[titrationdatatemp2]]]]]],#[[1]]&&#[[2]]&]],2];titrationdatatemp=Transpose[Table[Partition[titrationdatatrans[[i]],2],{i,Length[titrationdatatrans]}]];(*maxpos=Flatten[If[SubsetQ[tablefullinclwinfo[[mm,11]],{"NA"}],Position[tablefullinclwinfo[[mm,11]],Max[tablefullinclwinfo[[mm,11]]][[1]]],Position[tablefullinclwinfo[[mm,11]],Max[tablefullinclwinfo[[mm,11]]]]]][[1]];*)
allbase=Table[If[titrationdatatemp[[i,1,1]]<tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]],Mean[Select[titrationdatatemp[[i]],#[[1]]<tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]&][[All,2]]],titrationdatatemp[[i,1,2]]],{i,Length[titrationdatatemp]}];minbase=Min[allbase];(*refbase=allbase[[maxpos]];*)If[tablefullinclwinfo[[mm,16]]=="N"||tablefullinclwinfo[[mm,6]]==0,titrationdataraw=titrationdatatemp, If[tablefullinclwinfo[[mm,14]]=="Y",titrationdataraw=Table[Transpose[{titrationdatatemp[[i,All,1]],titrationdatatemp[[i,All,2]]-allbase[[i]]}],{i,Length[titrationdatatemp]}],titrationdataraw=Table[Transpose[{titrationdatatemp[[i,All,1]],titrationdatatemp[[i,All,2]]-minbase}],{i,Length[titrationdatatemp]}]]];sortedinclconc=DeleteDuplicates[DeleteCases[DeleteCases[Sort[tablefullinclwinfo[[mm,12]]],0.0],"NA"]];inclconcpos=Flatten[Table[Position[tablefullinclwinfo[[mm,11]],sortedinclconc[[i]]][[1]],{i,Length[sortedinclconc]}]];
If[SubsetQ[tablefullinclwinfo[[mm,11]],{0.0}]==False,titrationdatasorted=titrationdataraw[[inclconcpos]],zeropos=Flatten[Position[tablefullinclwinfo[[mm,11]],0.0]][[1]];titrationdatasorted=Table[Transpose[{titrationdataraw[[i,All,1]],titrationdataraw[[i,All,2]]-titrationdataraw[[zeropos,All,2]]}],{i,inclconcpos}]];
maxconcnum=5;If[Length[titrationdatasorted]<=maxconcnum||AllTrue[titrationdatasorted,Min[Select[#[[All,1]],NumberQ[#]&]]>tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]]-5||Max[Select[#[[All,1]],NumberQ[#]&]]<tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]]-10&],titrationdataselecttemp=titrationdatasorted;CanalyteConc=sortedinclconc,singletitrationresponse=Table[Mean[Select[titrationdatasorted[[j]],#[[1]]<=tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]]-5&&#[[1]]>=tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]]-10&&NumberQ[#[[2]]]&][[All,2]]],{j,1,Length[titrationdatasorted]}];singletitrationresponsediff=Join[{singletitrationresponse[[1]]},Table[singletitrationresponse[[j+1]]-singletitrationresponse[[j]],{j,1,Length[titrationdatasorted]-1}]];
singletitrationresponsewindow=Table[Total[singletitrationresponsediff[[Range[j,maxconcnum-1+j]]]],{j,1,Length[titrationdatasorted]-(maxconcnum-1)}];
maxtitrationposition=Position[singletitrationresponsewindow,Max[singletitrationresponsewindow]][[1,1]]+maxconcnum-1;CanalyteConc=sortedinclconc[[Range[maxtitrationposition-maxconcnum+1,maxtitrationposition]]];titrationdataselecttemp=titrationdatasorted[[Range[maxtitrationposition-maxconcnum+1,maxtitrationposition]]]];titrationdataselect=If[hertzrate==10,Table[First/@Partition[titrationdataselecttemp[[i]],10],{i,Length[titrationdataselecttemp]}],titrationdataselecttemp];singledatatofit=Flatten[Table[{If[titrationdataselect[[i,j,1]]<tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]],1,0],If[titrationdataselect[[i,j,1]]<tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]],0,1],titrationdataselect[[i,j,1]],i,titrationdataselect[[i,j,2]]},{i,Dimensions[titrationdataselect][[1]]},{j,1,Dimensions[titrationdataselect][[2]]}],1];singledatatofitnoempty =Select[Select[singledatatofit,#[[1]]>=0&&NumberQ[#[[5]]]&],(#[[3]]>=tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,9]]&&#[[3]]<=tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]])||(#[[3]]>=tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]]+tablefullinclwinfo[[mm,10]]&&#[[3]]<=tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]]+tablefullinclwinfo[[mm,8]])&];
singledatatofitnoemptyplot =Select[Select[singledatatofit,#[[1]]>=0&],#[[3]]>=tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]&&#[[3]]<=tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]]+If[plotlimit>tablefullinclwinfo[[mm,8]],plotlimit,tablefullinclwinfo[[mm,8]]]&];If[Length[singledatatofitnoempty]<1,parametertable=If[tablefullinclwinfo[[mm,17]]=="Y",Transpose[{{"Parameter","Rmax Global","ka","kd"},{"Value","NA","NA","NA"},{"StdErr","NA","NA","NA"}}],Transpose[{{"Parameter","Rmax 1","Rmax 2","Rmax 3","Rmax 4","Rmax 5","ka","kd"},{"Value","NA","NA","NA","NA","NA","NA","NA"},{"StdErr","NA","NA","NA","NA","NA","NA","NA"}}]];allparatable[[mm]]=parametertable;allparatableprint[[mm]]=parametertable;allparareport[[mm]]=Table["NA",{i,18}];allresidueplot[[mm]]=ListPlot[{0,0},ImageSize->Medium, BaseStyle->{FontSize->15},Frame->True,FrameLabel->{{"Response (RU)",None},{"Time (S)",None}}];allresponseplot[[mm]]=ListPlot[{0,0},ImageSize->Medium, BaseStyle->{FontSize->15},Frame->True,FrameLabel->{{"Response (RU)",None},{"Concentration (nM)",None}}];allauc[[mm]]=0;allplot[[mm]]=ListPlot[singledatatofitnoemptyplot[[All,{3,5}]],GridLines->{{{tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]],Red},{tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]],Red},{tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]]+tablefullinclwinfo[[mm,8]],Red}},None},ImageSize->Medium,  BaseStyle->{FontSize->15},Frame->True,FrameLabel->{{"Response (RU)",None},{"Time (S)",None}}],ymax=Max[Select[singledatatofitnoemptyplot[[All,5]],NumberQ[#]&]]*1.1;ymin=If[Min[Select[singledatatofitnoemptyplot[[All,5]],NumberQ[#]&]]>=0,0,Min[Select[singledatatofitnoemptyplot[[All,5]],NumberQ[#]&]]*1.1];t0=tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]];
tstartall=tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]];If[tablefullinclwinfo[[mm,17]]=="Y",nonsensefitglobal=Quiet[NonlinearModelFit[{{1,0,1,1,1}},{asc*RTRegenGlobal[t,ii]+dis*RTdisRegenGlobal[t,ii],Rmaxglobal<400},{Rmaxglobal,{ka,10000},kd},{asc,dis,t,ii}, MaxIterations->20000]];
nonsensefitbkglobal=Quiet[NonlinearModelFit[{{1,0,1,1,1}},{asc*RTRegenbkGlobal[t,ii]+dis*RTdisRegenbkGlobal[t,ii],Rmaxglobal<400},Join[{Rmaxglobal},Transpose[{shiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{{ka,10000},kd}],{asc,dis,t,ii}, MaxIterations->20000]];nonsensefitbkglobal2=Quiet[NonlinearModelFit[{{1,0,1,1,1}},{asc*RTRegenbkGlobal2[t,ii]+dis*RTdisRegenbkGlobal2[t,ii],Rmaxglobal<400},Join[{Rmaxglobal},Transpose[{bshiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{{ka,10000},kd}],{asc,dis,t,ii}, MaxIterations->20000]];If[tablefullinclwinfo[[mm,13]]=="Y",If[includeassobk==1,multifittemp= If[tablefullinclwinfo[[mm,14]]=="Y",Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenbkGlobal2[t,ii]+dis*RTdisRegenbkGlobal2[t,ii]},Join[{Rmaxglobal},Transpose[{bshiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefitbkglobal2]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenbkGlobal2[t,ii]+dis*RTdisNonregenbkGlobal2[t,ii]},Join[{Rmaxglobal},tstartlist[[Range[Length[CanalyteConc]]]],Transpose[{bshiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefitbkglobal2]]];
If[Quiet[Reverse[multifittemp["BestFitParameters"]][[1,2]]]>=kdfix,multifit=multifittemp;useless=0,multifit=If[tablefullinclwinfo[[mm,14]]=="Y",Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenkdbkGlobal2[t,ii]+dis*RTdisRegenkdbkGlobal2[t,ii]},Join[{Rmaxglobal},Transpose[{bshiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefitbkglobal2]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenkdbkGlobal2[t,ii]+dis*RTdisNonregenkdbkGlobal2[t,ii]},Join[{Rmaxglobal},tstartlist[[Range[Length[CanalyteConc]]]],Transpose[{bshiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefitbkglobal2]]]],multifittemp= If[tablefullinclwinfo[[mm,14]]=="Y",Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenbkGlobal[t,ii]+dis*RTdisRegenbkGlobal[t,ii]},Join[{Rmaxglobal},Transpose[{shiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefitbkglobal]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenbkGlobal[t,ii]+dis*RTdisNonregenbkGlobal[t,ii]},Join[{Rmaxglobal},tstartlist[[Range[Length[CanalyteConc]]]],Transpose[{shiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefitbkglobal]]];
If[Quiet[Reverse[multifittemp["BestFitParameters"]][[1,2]]]>=kdfix,multifit=multifittemp;useless=0,multifit=If[tablefullinclwinfo[[mm,14]]=="Y",Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenkdbkGlobal[t,ii]+dis*RTdisRegenkdbkGlobal[t,ii]},Join[{Rmaxglobal},Transpose[{shiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefitbkglobal]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenkdbkGlobal[t,ii]+dis*RTdisNonregenkdbkGlobal[t,ii]},Join[{Rmaxglobal},tstartlist[[Range[Length[CanalyteConc]]]],Transpose[{shiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefitbkglobal]]]]],multifittemp= If[tablefullinclwinfo[[mm,14]]=="Y",Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenGlobal[t,ii]+dis*RTdisRegenGlobal[t,ii],Rmaxglobal<400},Join[{Rmaxglobal},parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefitglobal]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenGlobal[t,ii]+dis*RTdisNonregenGlobal[t,ii]},Join[{Rmaxglobal},tstartlist[[Range[Length[CanalyteConc]]]],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefitglobal]]];
If[Quiet[Reverse[multifittemp["BestFitParameters"]][[1,2]]]>=kdfix,multifit=multifittemp;useless=0,multifit=If[tablefullinclwinfo[[mm,14]]=="Y",Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenkdGlobal[t,ii]+dis*RTdisRegenkdGlobal[t,ii]},{Rmaxglobal,ka},{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefitglobal]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenkdGlobal[t,ii]+dis*RTdisNonregenkdGlobal[t,ii]},Join[{Rmaxglobal},tstartlist[[Range[Length[CanalyteConc]]]],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefitglobal]]]]];parametertable=Transpose[{{"Parameter","Rmax Global","ka","kd","KD"},{"Value","NA","NA","NA","NA"},{"StdErr","NA","NA","NA","NA"}}];If[MatchQ[Quiet[multifit["ParameterTable"]],Missing[]]==False,tempparatable=Quiet[multifit["ParameterTable"]][[1,1]];parametertable[[2,{2,3}]]=tempparatable[[2,{2,3}]];If[MatchQ[tempparatable[[-1,1]],kd],parametertable[[{-3,-2},{2,3}]]=tempparatable[[{-2,-1},{2,3}]];parametertable[[-1,2]]=tempparatable[[-1,2]]/tempparatable[[-2,2]];parametertable[[-1,3]]=tempparatable[[-1,2]]/tempparatable[[-2,2]]*Sqrt[(tempparatable[[-1,3]]/tempparatable[[-1,2]])^2+(tempparatable[[-2,3]]/tempparatable[[-2,2]])^2],parametertable[[-3,{2,3}]]=tempparatable[[-1,{2,3}]];parametertable[[-2,2]]=kdfix;parametertable[[-1,2]]=kdfix/tempparatable[[-1,2]]]];allparatable[[mm]]=parametertable;allparatableprint[[mm]]=Join[{parametertable[[1]]},Table[If[i<3,{parametertable[[i,1]],NumberForm[parametertable[[i,2]],{\[Infinity],2}],NumberForm[parametertable[[i,3]],{\[Infinity],2}]},{parametertable[[i,1]],ScientificForm[parametertable[[i,2]],4],ScientificForm[parametertable[[i,3]],4]}],{i,2,Length[parametertable]}]];allparareport[[mm]]=Join[{"NA","NA","NA","NA","NA","NA","NA","NA","NA","NA"},Flatten[Drop[parametertable[[All,{2,3}]],1]]],
nonsensefit=Quiet[NonlinearModelFit[{{1,0,1,1,1}},Join[{asc*RTRegen[t,ii]+dis*RTdisRegen[t,ii]},Table[ToExpression[StringJoin[ToString[Rmaxlist[[i]]],"<400"]],{i,Length[CanalyteConc]}]],Join[Rmaxlist[[Range[Length[CanalyteConc]]]],{{ka,10000},kd}],{asc,dis,t,ii}, MaxIterations->20000]];
nonsensefitbk=Quiet[NonlinearModelFit[{{1,0,1,1,1}},Join[{asc*RTRegenbk[t,ii]+dis*RTdisRegenbk[t,ii]},Table[ToExpression[StringJoin[ToString[Rmaxlist[[i]]],"<400"]],{i,Length[CanalyteConc]}]],Join[Rmaxlist[[Range[Length[CanalyteConc]]]],Transpose[{shiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{{ka,10000},kd}],{asc,dis,t,ii}, MaxIterations->20000]];nonsensefitbk2=Quiet[NonlinearModelFit[{{1,0,1,1,1}},Join[{asc*RTRegenbk2[t,ii]+dis*RTdisRegenbk2[t,ii]},Table[ToExpression[StringJoin[ToString[Rmaxlist[[i]]],"<400"]],{i,Length[CanalyteConc]}]],Join[Rmaxlist[[Range[Length[CanalyteConc]]]],Transpose[{bshiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{{ka,10000},kd}],{asc,dis,t,ii}, MaxIterations->20000]];If[tablefullinclwinfo[[mm,13]]=="Y",If[includeassobk==1,multifittemp= If[tablefullinclwinfo[[mm,14]]=="Y",Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenbk2[t,ii]+dis*RTdisRegenbk2[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],Transpose[{bshiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefitbk2]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenbk2[t,ii]+dis*RTdisNonregenbk2[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],tstartlist[[Range[Length[CanalyteConc]]]],Transpose[{bshiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefitbk2]]];
If[Quiet[Reverse[multifittemp["BestFitParameters"]][[1,2]]]>=kdfix,multifit=multifittemp;useless=0,multifit=If[tablefullinclwinfo[[mm,14]]=="Y",Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenkdbk2[t,ii]+dis*RTdisRegenkdbk2[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],Transpose[{bshiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefitbk2]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenkdbk2[t,ii]+dis*RTdisNonregenkdbk2[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],tstartlist[[Range[Length[CanalyteConc]]]],Transpose[{bshiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefitbk2]]]],multifittemp= If[tablefullinclwinfo[[mm,14]]=="Y",Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenbk[t,ii]+dis*RTdisRegenbk[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],Transpose[{shiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefitbk]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenbk[t,ii]+dis*RTdisNonregenbk[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],tstartlist[[Range[Length[CanalyteConc]]]],Transpose[{shiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefitbk]]];
If[Quiet[Reverse[multifittemp["BestFitParameters"]][[1,2]]]>=kdfix,multifit=multifittemp;useless=0,multifit=If[tablefullinclwinfo[[mm,14]]=="Y",Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenkdbk[t,ii]+dis*RTdisRegenkdbk[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],Transpose[{shiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefitbk]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenkdbk[t,ii]+dis*RTdisNonregenkdbk[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],tstartlist[[Range[Length[CanalyteConc]]]],Transpose[{shiftlist[[Range[Length[CanalyteConc]]]],Table[10,{i,Length[CanalyteConc]}]}],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefitbk]]]]],multifittemp= If[tablefullinclwinfo[[mm,14]]=="Y",Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,Join[{asc*RTRegen[t,ii]+dis*RTdisRegen[t,ii]},Table[ToExpression[StringJoin[ToString[Rmaxlist[[i]]],"<400"]],{i,Length[CanalyteConc]}]],Join[Rmaxlist[[Range[Length[CanalyteConc]]]],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefit]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregen[t,ii]+dis*RTdisNonregen[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],tstartlist[[Range[Length[CanalyteConc]]]],parakakd],{asc,dis,t,ii}, MaxIterations->20000],timelimit,nonsensefit]]];
If[Quiet[Reverse[multifittemp["BestFitParameters"]][[1,2]]]>=kdfix,multifit=multifittemp;useless=0,multifit=If[tablefullinclwinfo[[mm,14]]=="Y",Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTRegenkd[t,ii]+dis*RTdisRegenkd[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefit]],Quiet[TimeConstrained[NonlinearModelFit[singledatatofitnoempty,{asc*RTNoregenkd[t,ii]+dis*RTdisNonregenkd[t,ii]},Join[Rmaxlist[[Range[Length[CanalyteConc]]]],tstartlist[[Range[Length[CanalyteConc]]]],{ka}],{asc,dis,t,ii}, MaxIterations->200000],timelimit,nonsensefit]]]]];parametertable=Transpose[{{"Parameter","Rmax 1","Rmax 2","Rmax 3","Rmax 4","Rmax 5","ka","kd","KD"},{"Value","NA","NA","NA","NA","NA","NA","NA","NA"},{"StdErr","NA","NA","NA","NA","NA","NA","NA","NA"}}];If[MatchQ[Quiet[multifit["ParameterTable"]],Missing[]]==False,tempparatable=Quiet[multifit["ParameterTable"]][[1,1]];parametertable[[1+Range[Length[CanalyteConc]],{2,3}]]=tempparatable[[1+Range[Length[CanalyteConc]],{2,3}]];If[MatchQ[tempparatable[[-1,1]],kd],parametertable[[{-3,-2},{2,3}]]=tempparatable[[{-2,-1},{2,3}]];parametertable[[-1,2]]=tempparatable[[-1,2]]/tempparatable[[-2,2]];parametertable[[-1,3]]=tempparatable[[-1,2]]/tempparatable[[-2,2]]*Sqrt[(tempparatable[[-1,3]]/tempparatable[[-1,2]])^2+(tempparatable[[-2,3]]/tempparatable[[-2,2]])^2],parametertable[[-3,{2,3}]]=tempparatable[[-1,{2,3}]];parametertable[[-2,2]]=kdfix;parametertable[[-1,2]]=kdfix/tempparatable[[-1,2]]]];allparatable[[mm]]=parametertable;allparatableprint[[mm]]=Join[{parametertable[[1]]},Table[If[i<7,{parametertable[[i,1]],NumberForm[parametertable[[i,2]],{\[Infinity],2}],NumberForm[parametertable[[i,3]],{\[Infinity],2}]},{parametertable[[i,1]],ScientificForm[parametertable[[i,2]],4],ScientificForm[parametertable[[i,3]],4]}],{i,2,Length[parametertable]}]];allparareport[[mm]]=Join[Flatten[Drop[parametertable[[All,{2,3}]],1]][[Range[1,10]]],{"NA","NA"},Flatten[Drop[parametertable[[All,{2,3}]],1]][[Range[-6,-1]]]]];aucreponselist=SortBy[Select[DeleteDuplicates[Join[Transpose[{tablefullinclwinfo[[mm,11]]*10^9,Table[Mean[Select[titrationdataraw[[j]],#[[1]]<=tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]]-5&&#[[1]]>=tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]]-15&&NumberQ[#[[2]]]&][[All,2]]],{j,1,Length[titrationdataraw]}]}],{{0,0}}],#1[[1]]==#2[[1]]&],NumberQ[#[[1]]]&],#1&];aucreponselistselect=Select[aucreponselist,SubsetQ[CanalyteConc*10^9,{#[[1]]}]&];responsetableind = Partition[{"NA","NA","NA","NA","NA","NA","NA","NA","NA","NA"},2];Table[responsetableind[[i]]=aucreponselistselect[[i]],{i,Length[aucreponselistselect]}];allresponsetable[[mm]]=responsetableind;allauc[[mm]]=Integrate[Interpolation[aucreponselist,InterpolationOrder->1][x],{x,0,Max[aucreponselist[[All,1]]]}];
allresponseplot[[mm]]=Show[ListPlot[Transpose[{Log[10,aucreponselist[[All,1]]],aucreponselist[[All,2]]}], ImageSize->Medium,BaseStyle->{FontSize->15},Frame->True,PlotStyle->PointSize[0.02],FrameLabel->{{"Response (RU)",None},{"log(Concentration (nM))",None}},PlotRange->All],ListPlot[Select[Transpose[{Log[10,aucreponselist[[All,1]]],aucreponselist[[All,2]]}],SubsetQ[Log[10,CanalyteConc*10^9],{#[[1]]}]&], PlotStyle->Directive[Red,PointSize[0.02]]],ListPlot[Transpose[{Log[10,aucreponselist[[All,1]]],aucreponselist[[All,2]]}],PlotRange->All,Joined->True,InterpolationOrder->1]];residueplottable=Table[{titrationdataselect[[i,j,1]],If[NumberQ[titrationdataselect[[i,j,1]]]==False||titrationdataselect[[i,j,1]]<tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]||titrationdataselect[[i,j,1]]>tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]]+tablefullinclwinfo[[mm,8]],"",titrationdataselect[[i,j,2]]-If[titrationdataselect[[i,j,1]]<tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]],Quiet[multifit[1,0,titrationdataselect[[i,j,1]],i]],Quiet[multifit[0,1,titrationdataselect[[i,j,1]],i]]]]},{i,Dimensions[titrationdataselect][[1]]},{j,1,Dimensions[titrationdataselect][[2]]}];allresidueplot[[mm]]=ListPlot[residueplottable,PlotRange->{{tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]],tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]]+If[plotlimit>tablefullinclwinfo[[mm,8]],plotlimit,tablefullinclwinfo[[mm,8]]]},Automatic},ImageSize->Medium, BaseStyle->{FontSize->15},Frame->True,FrameLabel->{{"Response (RU)",None},{"Time (S)",None}}];assoplot=Quiet[{multifit[1,0,t,1],multifit[1,0,t,2],multifit[1,0,t,3],multifit[1,0,t,4],multifit[1,0,t,5]}[[Reverse[Range[Length[CanalyteConc]]]]]];
dissplot=Quiet[{multifit[0,1,t,1],multifit[0,1,t,2],multifit[0,1,t,3],multifit[0,1,t,4],multifit[0,1,t,5]}[[Reverse[Range[Length[CanalyteConc]]]]]];
bulkline=Quiet[{{{t0,multifit[1,0,t0,1]},{t0,multifit[0,1,t0,1]}},{{t0,multifit[1,0,t0,2]},{t0,multifit[0,1,t0,2]}},{{t0,multifit[1,0,t0,3]},{t0,multifit[0,1,t0,3]}},{{t0,multifit[1,0,t0,4]},{t0,multifit[0,1,t0,4]}},{{t0,multifit[1,0,t0,5]},{t0,multifit[0,1,t0,5]}}}[[Reverse[Range[Length[CanalyteConc]]]]]];allplot[[mm]]=Show[{ListPlot[singledatatofitnoemptyplot[[All,{3,5}]],PlotStyle->Gray,PlotRange->{{tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]],tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]]+If[plotlimit>tablefullinclwinfo[[mm,8]],plotlimit,tablefullinclwinfo[[mm,8]]]},{ymin,ymax}},GridLines->{{{tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]],Red},{tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]],Red},{tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]]+If[plotlimit>tablefullinclwinfo[[mm,8]],plotlimit,tablefullinclwinfo[[mm,8]]],Red}},None},ImageSize->Medium,BaseStyle->{FontSize->15},Frame->True,FrameLabel->{{"Response (RU)",None},{"Time (S)",None}}],Plot[assoplot,{t,tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]],t0},PlotRange->{{tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]],tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]]+tablefullinclwinfo[[mm,8]]},{ymin,ymax}},PlotLegends->Reverse[CanalyteConc]*10^9],Plot[dissplot,{t,t0,tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]]+tablefullinclwinfo[[mm,8]]},PlotRange->{{tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]],tablefullinclwinfo[[mm,6]]+tablefullinclwinfo[[mm,15]]+tablefullinclwinfo[[mm,7]]+tablefullinclwinfo[[mm,8]]},{ymin,ymax}}],
ListLinePlot[bulkline]}]]];temptime=StringJoin[ToString[Now[[1,1]]],"_",ToString[Now[[1,2]]],"_",ToString[Now[[1,3]]]," ",ToString[Now[[1,4]]],"_",ToString[Now[[1,5]]]];fullreport=Join[{{"Ligand","Analyte","Chip","Channel","Fitting#","Rmax 1","Rmax 1 StdErr","Rmax 2","Rmax 2 StdErr","Rmax 3","Rmax 3 StdErr","Rmax 4","Rmax 4 StdErr","Rmax 5","Rmax 5 StdErr","Rmax Global","Rmax Global StdErr","ka","ka StdErr","kd","kd StdErr","KD","KD StdErr"}},Transpose[Join[Transpose[tablefullinclwinfo[[All,{5,4,2,3,18}]]],Transpose[allparareport]]]];Export[StringJoin[DirectoryName[gridpath],"Titration Analysis_T200_Report_",temptime,".csv"],fullreport];Export[StringJoin[DirectoryName[gridpath],"Titration Analysis_T200_Report_",temptime,".pdf"],Style[fullreport//TableForm,FontSize->15]];(*Export[StringJoin[DirectoryName[gridpath],"Titration Analysis_T200_Report_",temptime,".jpg"],Style[fullreport//TableForm,FontSize->15]];*)nb=CreateDocument[Table[Column[{Grid[{{allplot[[i]],allresponseplot[[i]]},{allresidueplot[[i]],Style[allparatableprint[[i]]//TableForm,ShowStringCharacters->False,FontSize->15]}},Alignment->{{Left,Top},{Top,Right}}],TextCell[Style[StringJoin[{"AUC: ",If[NumberQ[allauc[[i]]],ToString[DecimalForm[allauc[[i]]]],"0"]}],FontSize->20,ShowStringCharacters->False]],TextCell[ToString[tablefullinclwinfo[[i,5]]],"Section"],TextCell[ToString[tablefullinclwinfo[[i,4]]],"Section"]},"Center"],{i,Count[tablefull[[All,1]],"Y"]}],PrintingOptions->{"PaperSize"->{11*72,8.5*72},"PageSize"->{11*72,8.5*72}}];Export[StringJoin[DirectoryName[gridpath],"Titration Analysis_T200_Sensorgram_",temptime,".pdf"],nb];NotebookClose[nb];Print["T200 Titration Analysis Done"],Print["NOT all data files match the description provided in the information table"]],Print["NOT all data indicated in the information sheet are found"]],Print["Please correct error in the information table"]];Print["This is the end of the T200 module"],Print["This is not a valid platform"]]]]]]];
Print["End of program"]
]

End[]

EndPackage[]
